<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LatticeTwo â€” Interactive Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&display=swap" rel="stylesheet">
  <style>

    :root {

      --bg-deep: #0a0a0a;
      --bg-surface: #111;
      --bg-elevated: rgba(255, 255, 255, 0.02);
      --bg-hover: rgba(255, 255, 255, 0.04);
      --bg-active: rgba(255, 255, 255, 0.06);

      --border-subtle: rgba(255, 255, 255, 0.04);
      --border-visible: rgba(255, 255, 255, 0.08);

      --text-muted: #333;
      --text-tertiary: #444;
      --text-secondary: #555;
      --text-prose: #888;
      --text-primary: #ccc;
      --text-bright: #e5e5e5;
      --text-white: #fff;

      --amber: #fbbf24;
      --amber-bg: rgba(251, 191, 36, 0.12);
      --amber-border: rgba(251, 191, 36, 0.25);
      --blue: #60a5fa;
      --blue-bg: rgba(59, 130, 246, 0.12);
      --blue-border: rgba(59, 130, 246, 0.25);
      --purple: #a78bfa;
      --purple-bg: rgba(139, 92, 246, 0.15);
      --purple-border: rgba(139, 92, 246, 0.3);
      --green: #4ade80;
      --green-bg: rgba(34, 197, 94, 0.12);
      --green-border: rgba(34, 197, 94, 0.25);
      --red: #f87171;
      --red-bg: rgba(248, 113, 113, 0.12);

      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'SF Mono', Menlo, Monaco, monospace;

      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(6px); }
    }

    @keyframes annotationIn {
      from { opacity: 0; transform: translateY(-10px); }
    }

    @keyframes feedItemIn {
      from { opacity: 0; transform: translateY(10px) scale(0.95); }
    }

    @keyframes statusGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.15); }
      50% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.35); }
    }

    @keyframes thinkingSlide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(300%); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    @keyframes clickRipple {
      0% { transform: scale(0); opacity: 0.6; }
      100% { transform: scale(2.5); opacity: 0; }
    }

    @keyframes cursorPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes glowPulse {
      0%, 100% { box-shadow: 0 0 6px rgba(255, 255, 255, 0.3); }
      50% { box-shadow: 0 0 12px rgba(255, 255, 255, 0.5); }
    }

    @keyframes cardEnter {
      from { opacity: 0; transform: translateY(20px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes typeText {
      from { width: 0; }
      to { width: 100%; }
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    @keyframes celebrateGlow {
      0% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.5); }
      50% { box-shadow: 0 0 40px rgba(74, 222, 128, 0.8); }
      100% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.5); }
    }

    @keyframes tickerScroll {
      from { transform: translateX(0); }
      to { transform: translateX(-50%); }
    }

    @keyframes expandIn {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 500px; }
    }

    @keyframes tickerScrollReverse {
      from { transform: translateX(-50%); }
      to { transform: translateX(0); }
    }

    @keyframes agentMsgIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes conceptIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes float {
      0% { transform: translateY(100vh) translateX(0); opacity: 0; }
      10% { opacity: 0.5; }
      90% { opacity: 0.5; }
      100% { transform: translateY(-100vh) translateX(var(--drift, 50px)); opacity: 0; }
    }

    .screen {
      position: fixed;
      inset: 0;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.4s var(--ease-out-expo), visibility 0.4s;
    }

    .screen.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    #analysis-screen {
      background: var(--bg-surface);
    }

    .analysis-status {
      position: fixed;
      top: 48px;
      left: 64px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 100;
    }

    .logo {
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-tertiary);
    }

    .status-headline {
      font-size: 1.15rem;
      font-weight: 300;
      color: var(--text-prose);
      max-width: 360px;
      line-height: 1.5;
      opacity: 0;
      transform: translateY(4px);
      transition: all 0.5s var(--ease-out-expo);
    }

    .status-headline.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .status-headline em {
      color: var(--text-bright);
      font-style: normal;
    }

    .ascii-progress {
      display: flex;
      flex-direction: column;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.5s var(--ease-out-expo) 0.1s;
    }

    .ascii-progress.visible {
      opacity: 1;
    }

    .ascii-bar {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--text-tertiary);
      letter-spacing: 0.02em;
    }

    .ascii-bar .filled {
      color: var(--text-primary);
    }

    .ascii-status {
      font-size: 0.65rem;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .current-file {
      color: var(--text-secondary);
      font-family: var(--font-mono);
    }

    .stream-ticker {
      position: fixed;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
      height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 24px;
      opacity: 0;
      transition: opacity 1s ease;
      mask-image: linear-gradient(to right, transparent 0%, black 10%, black 90%, transparent 100%);
    }

    .stream-ticker.visible {
      opacity: 1;
    }

    .ticker-row {
      display: flex;
      white-space: nowrap;
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.06);
      letter-spacing: 0.02em;
    }

    .ticker-content {
      display: flex;
      animation: tickerScroll var(--duration, 60s) linear infinite;
    }

    .ticker-row.reverse .ticker-content {
      animation-name: tickerScrollReverse;
    }

    .ticker-item {
      padding: 0 32px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ticker-item .agent-dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      opacity: 0.5;
    }

    .ticker-item.agent-1 .agent-dot { background: var(--purple); }
    .ticker-item.agent-2 .agent-dot { background: var(--blue); }
    .ticker-item.agent-3 .agent-dot { background: var(--green); }

    .agent-center {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 420px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 50;
    }

    .agent-message {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 18px;
      background: rgba(20, 20, 20, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      animation: agentMsgIn 0.4s var(--ease-out-expo);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .agent-message.fading {
      opacity: 0;
      transform: translateY(-10px);
    }

    .agent-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 6px;
      font-size: 0.6rem;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .agent-badge .dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
    }

    .agent-message.agent-1 .agent-badge .dot { background: var(--purple); }
    .agent-message.agent-2 .agent-badge .dot { background: var(--blue); }
    .agent-message.agent-3 .agent-badge .dot { background: var(--green); }

    .agent-text {
      font-size: 0.82rem;
      color: var(--text-prose);
      line-height: 1.5;
    }

    .agent-text code {
      background: rgba(255, 255, 255, 0.04);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.9em;
      color: var(--text-primary);
    }

    .agent-text .highlight {
      color: var(--text-bright);
    }

    .concepts-bar {
      position: fixed;
      bottom: 48px;
      right: 64px;
      display: flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .concepts-bar.visible {
      opacity: 1;
    }

    .concepts-label {
      font-size: 0.55rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .concepts-list {
      display: flex;
      gap: 8px;
    }

    .concept-tag {
      padding: 6px 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 8px;
      font-size: 0.72rem;
      color: var(--text-secondary);
      animation: conceptIn 0.3s ease;
    }

    .hint-bar {
      position: fixed;
      bottom: 48px;
      left: 64px;
      display: flex;
      gap: 24px;
      font-size: 0.6rem;
      color: var(--text-muted);
    }

    .hint-bar kbd {
      background: rgba(255, 255, 255, 0.06);
      padding: 3px 8px;
      border-radius: 4px;
      margin-right: 5px;
      color: var(--text-tertiary);
    }

    .analysis-play-btn {
      position: fixed;
      bottom: 48px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 32px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: var(--text-bright);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.25s var(--ease-out-expo);
      z-index: 300;
    }

    .analysis-play-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
      transform: translateX(-50%) translateY(-2px);
    }

    .analysis-play-btn kbd {
      background: rgba(255, 255, 255, 0.08);
      padding: 4px 10px;
      border-radius: 5px;
      margin-right: 10px;
      font-size: 0.75rem;
    }

    .analysis-play-btn.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .ambient-particle {
      position: fixed;
      width: 2px;
      height: 2px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 50%;
      pointer-events: none;
      animation: float 30s linear infinite;
    }

    .particles-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    #dashboard-screen {
      background: var(--bg-deep);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 48px;
      position: relative;
      overflow: hidden;
    }

    .report-container {
      max-width: 700px;
      width: 100%;
      animation: fadeIn 0.6s var(--ease-out-expo);
    }

    .report-document {
      padding: 0 32px;
    }

    .report-header {
      margin-bottom: 48px;
    }

    .report-logo {
      font-size: 0.55rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-tertiary);
      margin-bottom: 12px;
    }

    .report-title {
      font-size: 2.2rem;
      font-weight: 200;
      color: var(--text-white);
      letter-spacing: -0.02em;
    }

    .analysis-text {
      font-size: 1.1rem;
      line-height: 1.85;
      font-weight: 300;
      letter-spacing: 0.01em;
      color: #b0b0b0;
      margin-bottom: 24px;
    }

    .analysis-text .highlight {
      color: #ffffff;
      font-weight: 400;
      text-shadow: 0 0 15px rgba(255, 255, 255, 0.25);
    }

    .inline-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 10px 3px 5px;
      border-radius: 5px;
      font-size: inherit;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s var(--ease-out-expo);
      vertical-align: baseline;
      line-height: inherit;
    }

    .inline-badge:hover {
      transform: translateY(-1px);
    }

    .inline-badge.active {
      transform: translateY(-1px);
    }

    .inline-badge .badge-key {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 3px;
      padding: 2px 5px;
      font-size: 0.6em;
      font-weight: 600;
      line-height: 1;
    }

    .inline-badge.amber {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.2);
      color: #fde68a;
    }
    .inline-badge.amber .badge-key { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .inline-badge.amber:hover { background: rgba(251, 191, 36, 0.15); }

    .inline-badge.blue {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: #93c5fd;
    }
    .inline-badge.blue .badge-key { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .inline-badge.blue:hover { background: rgba(59, 130, 246, 0.15); }

    .inline-badge.green {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      color: #86efac;
    }
    .inline-badge.green .badge-key { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .inline-badge.green:hover { background: rgba(34, 197, 94, 0.15); }

    .report-actions {
      display: flex;
      gap: 12px;
      margin-top: 48px;
      flex-wrap: wrap;
    }

    .report-action-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s var(--ease-out-expo);
    }

    .report-action-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--border-visible);
      transform: translateY(-2px);
    }

    .report-action-btn kbd {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .dashboard-hint-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 28px;
      padding: 14px 32px;
      background: linear-gradient(to top, rgba(10, 10, 10, 0.95), transparent);
      font-size: 0.6rem;
      color: #444;
      z-index: 50;
    }

    .dashboard-hint-bar span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .dashboard-hint-bar kbd {
      background: rgba(255, 255, 255, 0.06);
      padding: 2px 6px;
      border-radius: 3px;
      margin-right: 2px;
      color: #555;
    }

    .dashboard-annotation {
      display: flex;
      gap: 28px;
      padding: 24px;
      margin: 20px 0;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.02);
      animation: annotationOpen 0.35s var(--ease-out-expo);
      transform-origin: top left;
    }

    .dashboard-annotation.closing {
      animation: annotationClose 0.25s ease-out forwards;
    }

    @keyframes annotationOpen {
      from { opacity: 0; transform: scaleY(0.95) translateY(-8px); }
      to { opacity: 1; transform: scaleY(1) translateY(0); }
    }

    @keyframes annotationClose {
      from { opacity: 1; transform: scaleY(1); }
      to { opacity: 0; transform: scaleY(0.95) translateY(-8px); }
    }

    .dashboard-annotation.amber { border-color: rgba(251, 191, 36, 0.12); background: rgba(251, 191, 36, 0.02); }
    .dashboard-annotation.blue { border-color: rgba(59, 130, 246, 0.12); background: rgba(59, 130, 246, 0.02); }
    .dashboard-annotation.purple { border-color: rgba(139, 92, 246, 0.12); background: rgba(139, 92, 246, 0.02); }
    .dashboard-annotation.green { border-color: rgba(34, 197, 94, 0.12); background: rgba(34, 197, 94, 0.02); }

    .annotation-left {
      flex-shrink: 0;
      width: 160px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .annotation-header {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px 5px 5px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
      align-self: flex-start;
    }

    .annotation-header .header-key {
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 0.6rem;
      font-weight: 600;
    }

    .dashboard-annotation.amber .annotation-header { background: rgba(251, 191, 36, 0.1); color: #fde68a; }
    .dashboard-annotation.amber .header-key { background: rgba(251, 191, 36, 0.25); color: #fbbf24; }
    .dashboard-annotation.blue .annotation-header { background: rgba(59, 130, 246, 0.1); color: #93c5fd; }
    .dashboard-annotation.blue .header-key { background: rgba(59, 130, 246, 0.25); color: #60a5fa; }
    .dashboard-annotation.purple .annotation-header { background: rgba(139, 92, 246, 0.1); color: #c4b5fd; }
    .dashboard-annotation.purple .header-key { background: rgba(139, 92, 246, 0.25); color: #a78bfa; }
    .dashboard-annotation.green .annotation-header { background: rgba(34, 197, 94, 0.1); color: #86efac; }
    .dashboard-annotation.green .header-key { background: rgba(34, 197, 94, 0.25); color: #4ade80; }

    .annotation-stat {
      font-size: 3rem;
      font-weight: 200;
      line-height: 1;
      letter-spacing: -0.02em;
      font-variant-numeric: tabular-nums;
      color: var(--text-white);
    }

    .annotation-stat sup {
      font-size: 0.4em;
      font-weight: 400;
      color: var(--text-tertiary);
      margin-left: 4px;
    }

    .annotation-ticker {
      overflow: hidden;
      height: 18px;
      mask-image: linear-gradient(90deg, transparent 0%, black 10%, black 90%, transparent 100%);
    }

    .annotation-ticker-inner {
      display: flex;
      gap: 16px;
      animation: tickerScroll 20s linear infinite;
      white-space: nowrap;
    }

    .annotation-ticker-inner span {
      font-size: 0.65rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-tertiary);
    }

    .dashboard-annotation.amber .annotation-ticker-inner span { color: rgba(251, 191, 36, 0.5); }
    .dashboard-annotation.blue .annotation-ticker-inner span { color: rgba(59, 130, 246, 0.5); }
    .dashboard-annotation.purple .annotation-ticker-inner span { color: rgba(139, 92, 246, 0.5); }
    .dashboard-annotation.green .annotation-ticker-inner span { color: rgba(34, 197, 94, 0.5); }

    @keyframes tickerScroll {
      from { transform: translateX(0); }
      to { transform: translateX(-50%); }
    }

    .annotation-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-width: 0;
    }

    .annotation-prose {
      font-size: 0.88rem;
      line-height: 1.7;
      font-weight: 300;
      color: #888;
    }

    .annotation-prose strong {
      color: #fff;
      font-weight: 400;
    }

    .annotation-prose em {
      font-style: normal;
      color: #ccc;
    }

    .annotation-prose code {
      background: rgba(255, 255, 255, 0.06);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', monospace;
      font-size: 0.85em;
      color: #999;
    }

    .annotation-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .annotation-action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 400;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .annotation-action:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .annotation-action.primary {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.12);
      color: var(--text-primary);
    }

    .annotation-action .key {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 0.6rem;
      font-weight: 600;
    }

    .annotation-input {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 8px;
      margin-top: 4px;
    }

    .annotation-input .input-arrow {
      color: var(--text-tertiary);
      font-size: 0.8rem;
    }

    .annotation-input-field {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-family: inherit;
      font-size: 0.8rem;
      color: var(--text-primary);
    }

    .annotation-input-field::placeholder {
      color: #444;
    }

    .annotation-input .input-hint {
      font-size: 0.55rem;
      color: #333;
    }

    .annotation-input .input-hint kbd {
      background: rgba(255, 255, 255, 0.06);
      padding: 2px 5px;
      border-radius: 3px;
    }

    .card-conversation {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-exchange {
      display: flex;
      flex-direction: column;
      gap: 4px;
      animation: fadeIn 0.3s ease;
    }

    .card-query {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .card-query .arrow {
      color: var(--text-tertiary);
    }

    .card-response {
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.5;
      padding-left: 14px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: var(--font-family);
      background: var(--bg-deep);
      color: var(--text-bright);
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 3px;
    }

    ::selection {
      background: rgba(139, 92, 246, 0.3);
    }

    kbd {
      display: inline-block;
      background: var(--bg-active);
      border-radius: 3px;
      padding: 2px 6px;
      font-family: inherit;
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .mock-cursor {
      position: fixed;
      width: 20px;
      height: 20px;
      pointer-events: none;
      z-index: 10000;
      transition: left 0.8s cubic-bezier(0.25, 0.1, 0.25, 1), 
                  top 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    .mock-cursor svg {
      width: 20px;
      height: 20px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    }

    .mock-cursor.clicking {
      animation: cursorPulse 0.15s ease;
    }

    .click-ripple {
      position: fixed;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      pointer-events: none;
      z-index: 9999;
      animation: clickRipple 0.4s ease-out forwards;
    }

    .narration-bar {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 32px;
      background: linear-gradient(180deg, rgba(10, 10, 10, 0.85) 0%, rgba(10, 10, 10, 0.95) 100%);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      backdrop-filter: blur(20px);
      z-index: 9000;
      opacity: 0;
      transition: opacity 0.5s ease;
      max-width: 600px;
      text-align: center;
    }

    .narration-bar.visible {
      opacity: 1;
    }

    .narration-text {
      font-size: 14px;
      font-weight: 300;
      color: var(--text-prose);
      line-height: 1.6;
    }

    .narration-text em {
      color: var(--text-white);
      font-style: normal;
    }

    .status-island {
      position: fixed;
      top: 16px;
      right: 16px;
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 24px;
      z-index: 8000;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.4s var(--ease-out-expo);
    }

    .status-island.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .status-island.success {
      border-color: var(--green-border);
      animation: celebrateGlow 1.5s ease;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-prose);
    }

    .status-dot.active {
      background: var(--green);
      animation: statusGlow 2s ease infinite;
    }

    .status-text {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-primary);
    }

    .status-progress {
      width: 60px;
      height: 3px;
      background: var(--bg-active);
      border-radius: 2px;
      overflow: hidden;
    }

    .status-progress-fill {
      height: 100%;
      background: var(--green);
      transition: width 0.3s ease;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
      animation: fadeIn 0.5s ease;
    }

    .nav-bar {
      display: flex;
      align-items: center;
      gap: 4px;
      height: 48px;
      padding: 0 24px;
      border-bottom: 1px solid var(--border-subtle);
      flex-shrink: 0;
    }

    .nav-tab {
      padding: 8px 14px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s var(--ease-out-expo);
      position: relative;
      overflow: hidden;
    }

    .nav-tab::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: var(--glow-x, 50%);
      transform: translateX(-50%);
      width: 0;
      height: 2px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 1px;
      transition: width 0.2s ease, background 0.2s ease;
    }

    .nav-tab:hover {
      background: var(--bg-elevated);
      color: var(--text-prose);
    }

    .nav-tab:hover::before {
      width: 12px;
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
    }

    .nav-tab.active {
      background: var(--bg-hover);
      color: var(--text-bright);
    }

    .nav-tab.active::before {
      width: 20px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.5);
      animation: glowPulse 2s ease infinite;
    }

    .spacer {
      flex: 1;
    }

    .calculate-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border-visible);
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s var(--ease-out-expo);
    }

    .calculate-btn:hover {
      background: var(--bg-hover);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .content {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-left {
      width: 240px;
      border-right: 1px solid var(--border-subtle);
    }

    .panel-center {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .panel-right {
      width: 360px;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 0 12px;
      border-bottom: 1px solid var(--border-subtle);
      height: 44px; 
      flex-shrink: 0;
    }

    .panel-tab {
      padding: 6px 10px;
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .panel-tab:hover {
      background: var(--bg-elevated);
      color: var(--text-prose);
    }

    .panel-tab.active {
      background: var(--bg-hover);
      color: var(--text-bright);
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px 6px 16px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 4px;
      margin: 1px 4px;
    }

    .file-item:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
      transform: translateX(2px);
    }

    .file-item.active {
      background: var(--bg-hover);
      color: var(--text-bright);
    }

    .file-item .icon {
      opacity: 0.5;
      font-size: 10px;
      margin-right: 6px;
    }

    .folder-item {
      padding-left: 12px;
    }

    .folder-item .icon {
      font-size: 8px;
    }

    .nested {
      padding-left: 12px;
    }

    .file-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }

    .file-badge.green {
      background: var(--green-bg);
      color: var(--green);
    }

    .file-badge.amber {
      background: var(--amber-bg);
      color: var(--amber);
    }

    .file-badge.red {
      background: var(--red-bg);
      color: var(--red);
    }

    .editor-tabs {
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 0 12px;
      height: 44px; 
      flex-shrink: 0;
      position: relative;
    }

    .editor-tabs::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 20px;
      right: 20%;
      height: 1px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.06) 75%, transparent 100%);
    }

    .editor-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 0 10px;
      height: 26px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 5px;
      font-size: 11px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .editor-tab:hover {
      background: var(--bg-elevated);
    }

    .editor-tab.active {
      background: var(--bg-hover);
      border-color: var(--border-visible);
      color: var(--text-primary);
    }

    .editor-tab .close {
      font-size: 12px;
      color: var(--text-tertiary);
      transition: color 0.15s ease;
    }

    .editor-tab .close:hover {
      color: var(--red);
    }

    .editor-code {
      flex: 1;
      padding: 16px 20px;
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-prose);
      overflow: auto;
    }

    .code-line {
      display: flex;
    }

    .code-line.highlight {
      background: rgba(74, 222, 128, 0.08);
      margin: 0 -20px;
      padding: 0 20px;
      border-left: 2px solid var(--green);
    }

    .line-num {
      width: 40px;
      text-align: right;
      padding-right: 16px;
      color: var(--text-muted);
      user-select: none;
    }

    .code-keyword { color: #c678dd; }
    .code-string { color: #98c379; }
    .code-comment { color: #5c6370; font-style: italic; }
    .code-function { color: #61afef; }
    .code-type { color: #e5c07b; }
    .code-number { color: #d19a66; }

    .stats-row {
      position: relative;
      display: flex;
      gap: 16px;
      padding: 20px 20px;
      flex-shrink: 0;
    }

    .stats-row::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 20px;
      right: 20%;
      height: 1px;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.06) 75%, transparent 100%);
    }

    .stat-card {
      position: relative;
      padding: 14px 18px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.25s var(--ease-out-expo);
      overflow: hidden;
      max-width: 320px;
      flex: 1;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card.green {
      border-color: rgba(74, 222, 128, 0.2);
      background: rgba(74, 222, 128, 0.03);
    }
    .stat-card.green::before {
      box-shadow: 0 0 25px rgba(74, 222, 128, 0.15);
    }

    .stat-card.neutral {
      border-color: rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.02);
    }
    .stat-card.neutral::before {
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.08);
    }
    .stat-card.neutral .stat-value {
      color: #888;
    }
    .stat-card.neutral.active {
      border-color: rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
    }

    .stat-hotkey {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      color: #555;
      min-width: 16px;
      text-align: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .stat-card:hover .stat-hotkey,
    .stat-card.expanded .stat-hotkey {
      color: #777;
      background: rgba(255, 255, 255, 0.08);
    }

    .stat-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .stat-card.amber {
      border-color: rgba(251, 191, 36, 0.2);
      background: rgba(251, 191, 36, 0.03);
    }
    .stat-card.amber::before {
      box-shadow: 0 0 25px rgba(251, 191, 36, 0.15);
    }

    .stat-card.red {
      border-color: rgba(248, 113, 113, 0.2);
      background: rgba(248, 113, 113, 0.03);
    }
    .stat-card.red::before {
      box-shadow: 0 0 25px rgba(248, 113, 113, 0.15);
    }

    .stat-main {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 200;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.02em;
      line-height: 1;
    }

    .stat-card.green .stat-value { color: var(--green); }
    .stat-card.amber .stat-value { color: var(--amber); }
    .stat-card.red .stat-value { color: var(--red); }

    .stat-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stat-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .stat-sublabel {
      font-size: 0.65rem;
      color: var(--text-tertiary);
    }

    .stat-expand-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: var(--text-tertiary);
      opacity: 0;
      transition: opacity 0.2s ease, transform 0.25s var(--ease-out-expo);
    }

    .stat-card:hover .stat-expand-icon {
      opacity: 1;
    }

    .stat-card.expanded .stat-expand-icon {
      opacity: 1;
      transform: rotate(45deg);
    }

    .stat-expanded {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: all 0.3s var(--ease-out-expo);
    }

    .stat-card.expanded .stat-expanded {
      max-height: 280px;
      opacity: 1;
      padding-top: 14px;
      margin-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .stat-detail {
      font-size: 0.72rem;
      color: var(--text-prose);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .stat-summary {
      font-size: 0.8rem;
      color: var(--text-prose);
      line-height: 1.6;
      font-weight: 300;
      margin-bottom: 14px;
    }

    .stat-qa {
      margin-bottom: 14px;
    }

    .stat-qa-item {
      margin-bottom: 10px;
    }

    .stat-qa-question {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-size: 0.72rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .stat-qa-question .arrow {
      color: var(--text-tertiary);
    }

    .stat-qa-answer {
      font-size: 0.78rem;
      color: var(--text-prose);
      line-height: 1.5;
      padding-left: 16px;
      font-weight: 300;
    }

    .stat-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .stat-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      font-size: 0.65rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s var(--ease-out-expo);
    }

    .stat-action-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--border-visible);
      color: var(--text-primary);
      transform: translateY(-1px);
    }

    .stat-action-btn kbd {
      padding: 2px 5px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      font-size: 0.55rem;
      color: #777;
    }

    .stat-input {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 8px;
      margin: 12px 0;
    }

    .stat-input .input-arrow {
      color: var(--text-tertiary);
      font-size: 0.8rem;
    }

    .stat-input-field {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-family: inherit;
      font-size: 0.8rem;
      color: var(--text-primary);
    }

    .stat-input-field::placeholder {
      color: #444;
    }

    .stat-input .input-hint {
      font-size: 0.55rem;
      color: #333;
    }

    .stat-input .input-hint kbd {
      background: rgba(255, 255, 255, 0.06);
      padding: 2px 5px;
      border-radius: 3px;
    }

    .stat-conversation {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .stat-exchange {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 8px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.03);
      animation: fadeIn 0.3s ease;
    }

    .stat-query {
      font-size: 0.72rem;
      color: var(--text-tertiary);
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .stat-query .arrow {
      color: var(--text-tertiary);
    }

    .stat-response {
      font-size: 0.78rem;
      color: var(--text-secondary);
      line-height: 1.5;
      padding-left: 14px;
    }

    .stat-summary {
      font-size: 0.85rem;
      line-height: 1.7;
      font-weight: 300;
      color: var(--text-prose);
      margin-bottom: 12px;
    }

    .stat-summary strong {
      color: var(--text-white);
      font-weight: 400;
    }

    .stat-summary em {
      font-style: normal;
      color: var(--text-primary);
    }

    .stat-summary code {
      background: rgba(255, 255, 255, 0.06);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.85em;
      color: #999;
    }

    .stat-qa-answer {
      font-size: 0.78rem;
      line-height: 1.6;
      font-weight: 300;
      color: var(--text-prose);
    }

    .stat-qa-answer code {
      background: rgba(255, 255, 255, 0.06);
      padding: 1px 5px;
      border-radius: 3px;
      font-family: var(--font-mono);
      font-size: 0.9em;
      color: #999;
    }

    .stat-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.08), rgba(34, 197, 94, 0.15));
      transition: width 0.1s linear;
      z-index: 0;
      pointer-events: none;
      border-radius: 10px;
    }

    .stat-card.filling::after {
      transition: width 1.5s linear 0.25s;
      width: 100%;
    }

    .stat-card.confirmed {
      border-color: rgba(34, 197, 94, 0.2);
      background: rgba(34, 197, 94, 0.04);
    }

    .stat-card.confirmed::after {
      width: 100%;
      background: rgba(34, 197, 94, 0.1);
    }

    .stat-card.confirmed .stat-hotkey {
      background: rgba(34, 197, 94, 0.2);
      color: var(--green);
    }

    .stat-card > * {
      position: relative;
      z-index: 1;
    }

    .command-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: auto;
      margin-right: 12px;
    }

    .command-stat {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      font-size: 0.65rem;
      color: var(--text-secondary);
    }

    .command-stat-value {
      font-weight: 500;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
    }

    .command-stat.warning .command-stat-value {
      color: var(--amber);
    }

    .command-stat.success .command-stat-value {
      color: var(--green);
    }

    .fix-all-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.65rem;
      line-height: 1;
      cursor: pointer;
      transition: all 0.25s var(--ease-out-expo);
      overflow: hidden;
    }

    .fix-all-btn::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: var(--progress, 0%);
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
      transition: width 0.3s ease;
      z-index: 0;
    }

    .fix-all-btn > * {
      position: relative;
      z-index: 1;
    }

    .fix-all-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
      color: var(--text-primary);
    }

    .fix-all-btn.working {
      pointer-events: none;
      min-width: 140px;
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.15);
      color: var(--text-primary);
    }

    .fix-all-btn.working::before {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
      animation: shimmer 1.5s ease infinite;
    }

    @keyframes shimmer {
      0% { opacity: 0.8; }
      50% { opacity: 1; }
      100% { opacity: 0.8; }
    }

    .fix-all-btn.complete {
      background: rgba(74, 222, 128, 0.15);
      border-color: rgba(74, 222, 128, 0.4);
      color: var(--green);
    }

    .fix-all-btn kbd {
      padding: 2px 5px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 3px;
      font-size: 0.55rem;
      color: var(--text-tertiary);
      line-height: 1;
    }

    .fix-all-btn .fix-text {
      white-space: nowrap;
    }

    .fix-all-btn .fix-progress-text {
      font-variant-numeric: tabular-nums;
    }

    .nav-tab[data-tab="activity"] {
      position: relative;
    }

    .nav-tab[data-tab="activity"] .activity-indicator {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 6px;
      height: 6px;
      background: var(--green);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .nav-tab[data-tab="activity"].has-activity .activity-indicator {
      opacity: 1;
      animation: pulse 2s ease infinite;
    }

    .stat-change {
      font-size: 10px;
      margin-top: 4px;
      font-weight: 500;
    }

    .stat-change.positive { color: var(--green); }
    .stat-change.negative { color: var(--red); }

    .panel-right {
      padding-top: 20px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-empty {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      height: 100%;
      gap: 8px;
      padding-top: 8px;
    }

    .chat-empty-label {
      font-size: 0.6rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-tertiary);
    }

    .chat-empty-hint {
      font-size: 0.85rem;
      font-weight: 300;
      color: var(--text-muted);
    }

    .exchange {
      padding: 12px 0;
      border-bottom: 1px solid var(--border-subtle);
      animation: slideIn 0.25s var(--ease-out-expo);
    }

    .query {
      font-size: 13px;
      color: var(--text-prose);
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .query-arrow {
      color: var(--text-tertiary);
      font-size: 12px;
    }

    .query-text {
      font-weight: 300;
    }

    .typing-cursor {
      display: inline-block;
      width: 2px;
      height: 14px;
      background: var(--text-prose);
      margin-left: 2px;
      animation: blink 0.8s infinite;
      vertical-align: middle;
    }

    .response {
      padding-left: 18px;
      margin-top: 8px;
    }

    .response-headline {
      font-size: 1.2rem;
      font-weight: 300;
      color: var(--text-primary);
      line-height: 1.5;
      letter-spacing: -0.01em;
    }

    .response-headline em {
      color: var(--text-white);
      font-style: normal;
    }

    .response-detail {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
      font-weight: 300;
    }

    .thinking {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-left: 18px;
      margin-top: 8px;
    }

    .thinking-bar {
      height: 2px;
      width: 60px;
      background: var(--bg-active);
      border-radius: 1px;
      overflow: hidden;
    }

    .thinking-bar-fill {
      height: 100%;
      width: 30%;
      background: linear-gradient(90deg, transparent, var(--text-prose), transparent);
      animation: thinkingSlide 1s ease-in-out infinite;
    }

    .thinking-text {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 300;
    }

    .annotation-card {
      display: flex;
      gap: 20px;
      padding: 16px 18px;
      border-radius: 12px;
      animation: cardEnter 0.35s var(--ease-out-expo);
      margin-top: 8px;
      transition: all 0.25s ease;
    }

    .annotation-card.green {
      background: rgba(74, 222, 128, 0.04);
      border: 1px solid rgba(74, 222, 128, 0.1);
    }

    .annotation-card.amber {
      background: rgba(251, 191, 36, 0.04);
      border: 1px solid rgba(251, 191, 36, 0.1);
    }

    .annotation-card.blue {
      background: rgba(96, 165, 250, 0.04);
      border: 1px solid rgba(96, 165, 250, 0.1);
    }

    .annotation-card.applied {
      background: rgba(74, 222, 128, 0.08);
      border-color: rgba(74, 222, 128, 0.2);
    }

    .annotation-left {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 120px;
    }

    .annotation-header {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 8px 4px 4px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 500;
      align-self: flex-start;
    }

    .annotation-card.green .annotation-header {
      background: rgba(74, 222, 128, 0.12);
      color: var(--green);
    }

    .annotation-card.amber .annotation-header {
      background: rgba(251, 191, 36, 0.12);
      color: var(--amber);
    }

    .annotation-card.blue .annotation-header {
      background: rgba(96, 165, 250, 0.12);
      color: var(--blue);
    }

    .header-key {
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
    }

    .annotation-card.green .header-key {
      background: rgba(74, 222, 128, 0.25);
      color: var(--green);
    }

    .annotation-card.amber .header-key {
      background: rgba(251, 191, 36, 0.25);
      color: var(--amber);
    }

    .annotation-card.blue .header-key {
      background: rgba(96, 165, 250, 0.25);
      color: var(--blue);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 200;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }

    .annotation-card.green .stat-number { color: var(--green); }
    .annotation-card.amber .stat-number { color: var(--amber); }
    .annotation-card.blue .stat-number { color: var(--blue); }

    .stat-number sup {
      font-size: 0.4em;
      color: var(--text-secondary);
      font-weight: 400;
      margin-left: 4px;
    }

    .stat-ticker {
      overflow: hidden;
      height: 16px;
      mask-image: linear-gradient(90deg, transparent, black 10%, black 90%, transparent);
    }

    .ticker-inner {
      display: flex;
      gap: 16px;
      width: max-content;
      animation: tickerScroll 20s linear infinite;
    }

    .ticker-inner span {
      font-size: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      white-space: nowrap;
      opacity: 0.5;
    }

    .annotation-card.green .ticker-inner span { color: var(--green); }
    .annotation-card.amber .ticker-inner span { color: var(--amber); }
    .annotation-card.blue .ticker-inner span { color: var(--blue); }

    .annotation-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 0;
    }

    .annotation-prose {
      font-size: 13px;
      line-height: 1.7;
      font-weight: 300;
      color: var(--text-prose);
    }

    .annotation-prose strong {
      color: var(--text-primary);
      font-weight: 400;
    }

    .annotation-prose code {
      background: var(--bg-active);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.9em;
      color: var(--text-secondary);
    }

    .annotation-path {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-prose);
    }

    .annotation-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 10px 6px 6px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
    }

    .action-btn.primary {
      background: rgba(74, 222, 128, 0.12);
      border: 1px solid rgba(74, 222, 128, 0.2);
      color: var(--green);
    }

    .action-btn.primary:hover {
      background: rgba(74, 222, 128, 0.2);
      transform: translateY(-1px);
    }

    .action-btn.primary kbd {
      background: rgba(74, 222, 128, 0.25);
      color: var(--green);
    }

    .action-btn.secondary {
      background: var(--bg-active);
      border: 1px solid var(--border-visible);
      color: var(--text-secondary);
    }

    .action-btn.secondary:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .action-btn.used {
      opacity: 0.4;
      pointer-events: none;
    }

    .applied-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--green);
      font-weight: 500;
    }

    .annotation-input {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-top: 10px;
      border-top: 1px solid var(--border-subtle);
      margin-top: 4px;
    }

    .annotation-input .input-arrow {
      color: var(--text-muted);
      font-size: 11px;
    }

    .card-input-field {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-family: inherit;
      font-size: 12px;
      font-weight: 300;
      color: var(--text-prose);
    }

    .card-input-field::placeholder {
      color: var(--text-tertiary);
    }

    .card-input-field:focus {
      color: var(--text-primary);
    }

    .annotation-input .input-hint {
      font-size: 9px;
      color: var(--text-muted);
    }

    .card-conversation {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-exchange {
      padding: 8px 0;
      border-top: 1px solid var(--border-subtle);
      animation: fadeInUp 0.2s ease;
    }

    .card-query {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .card-query .arrow {
      color: var(--text-tertiary);
      margin-right: 4px;
    }

    .card-response {
      font-size: 12px;
      color: var(--text-prose);
      line-height: 1.6;
    }

    .chat-input {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 24px 32px 24px 24px;
      flex-shrink: 0;
      background: transparent;
      position: relative;
    }

    .chat-input::before {
      content: '';
      position: absolute;
      top: 0;
      left: 24px;
      right: 32px;
      height: 1px;
      background: rgba(255, 255, 255, 0.05);
    }

    .chat-input .arrow {
      color: #555;
      font-size: 1rem;
      transition: color 0.15s ease;
      animation: arrowScroll 5s ease-in-out infinite;
      display: inline-block;
      overflow: hidden;
      width: 1em;
    }

    @keyframes arrowScroll {
      0%, 80% {
        transform: translateX(0);
        opacity: 1;
      }
      88% {
        transform: translateX(12px);
        opacity: 0;
      }
      89% {
        transform: translateX(-12px);
        opacity: 0;
      }
      97% {
        transform: translateX(0);
        opacity: 1;
      }
      100% {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .chat-input:focus-within .arrow {
      color: #888;
      animation: none;
    }

    .chat-input input {
      flex: 1;
      background: transparent;
      border: none;
      color: #888;
      font-size: 1.05rem;
      font-weight: 300;
      outline: none;
    }

    .chat-input input:focus {
      color: #ccc;
    }

    .chat-input input::placeholder {
      color: #555;
    }

    .chat-input .hint {
      font-size: 0.65rem;
      color: #444;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .chat-input:focus-within .hint {
      opacity: 1;
    }

    .chat-input .hint kbd {
      background: rgba(255, 255, 255, 0.06);
      padding: 2px 6px;
      border-radius: 3px;
    }

    .chat-user-message {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 8px 0;
      animation: fadeIn 0.3s ease;
    }

    .chat-user-message .user-arrow {
      color: #666;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .chat-user-message .user-text {
      color: #aaa;
      font-size: 0.95rem;
      font-weight: 300;
      line-height: 1.5;
    }

    .chat-thinking {
      padding: 16px 0 8px 24px;
      animation: fadeIn 0.3s ease;
    }

    .thinking-dots {
      display: flex;
      gap: 4px;
    }

    .thinking-dots span {
      width: 6px;
      height: 6px;
      background: #444;
      border-radius: 50%;
      animation: dotPulse 1.4s ease-in-out infinite;
    }

    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes dotPulse {
      0%, 80%, 100% { opacity: 0.3; transform: scale(1); }
      40% { opacity: 1; transform: scale(1.2); }
    }

    .chat-ai-response {
      padding: 16px 0 12px 24px;
      animation: fadeIn 0.4s ease;
    }

    .chat-ai-response .response-headline {
      color: #e0e0e0;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 10px;
      letter-spacing: 0.02em;
    }

    .chat-ai-response .response-detail {
      color: #888;
      font-size: 0.9rem;
      font-weight: 300;
      line-height: 1.7;
      margin-bottom: 14px;
    }

    .chat-ai-response .response-detail .highlight {
      color: #fff;
      font-weight: 400;
    }

    .chat-ai-response .response-detail .code-ref {
      color: #7dd3fc;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-size: 0.85em;
      background: rgba(125, 211, 252, 0.08);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .response-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .response-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      color: #888;
      font-size: 0.8rem;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .response-action-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #ccc;
      border-color: rgba(255, 255, 255, 0.12);
    }

    .response-action-btn.primary {
      background: rgba(74, 222, 128, 0.1);
      border-color: rgba(74, 222, 128, 0.2);
      color: #4ade80;
    }

    .response-action-btn.primary:hover {
      background: rgba(74, 222, 128, 0.18);
      border-color: rgba(74, 222, 128, 0.3);
    }

    .response-action-btn kbd {
      background: rgba(255, 255, 255, 0.08);
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .response-action-btn.primary kbd {
      background: rgba(74, 222, 128, 0.2);
    }

    .insight-container {
      padding: 32px 40px;
      height: 100%;
      overflow-y: auto;
      max-width: 900px;
    }

    .insight-header {
      margin-bottom: 32px;
    }

    .insight-title {
      font-size: 1.8rem;
      font-weight: 200;
      color: var(--text-bright);
      margin-bottom: 8px;
    }

    .insight-summary {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 300;
      line-height: 1.6;
      max-width: 500px;
    }

    .insight-summary .highlight {
      color: var(--text-bright);
      font-weight: 500;
    }

    .insight-toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      flex: 1;
      max-width: 280px;
      transition: all 0.2s ease;
    }

    .search-box:focus-within {
      border-color: var(--border-visible);
      background: var(--bg-hover);
    }

    .search-box .icon {
      color: var(--text-tertiary);
      font-size: 11px;
      font-weight: 300;
    }

    .search-icon {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .search-icon svg {
      width: 14px;
      height: 14px;
      stroke: currentColor;
      stroke-width: 1.5;
      fill: none;
    }

    .search-box input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-size: 12px;
      color: var(--text-prose);
    }

    .search-box input::placeholder {
      color: var(--text-tertiary);
    }

    .filter-pills {
      display: flex;
      gap: 6px;
    }

    .filter-pill {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .filter-pill:hover {
      background: var(--bg-hover);
      color: var(--text-prose);
    }

    .filter-pill.active {
      background: var(--bg-active);
      border-color: var(--border-visible);
      color: var(--text-primary);
    }

    .sort-dropdown-container {
      position: relative;
    }

    .sort-dropdown {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      font-size: 11px;
      font-weight: 400;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sort-dropdown:hover {
      background: var(--bg-hover);
      border-color: var(--border-visible);
      color: var(--text-prose);
    }

    .sort-dropdown.active {
      background: var(--bg-active);
      border-color: var(--border-visible);
      color: var(--text-primary);
    }

    .sort-icon {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 12px;
    }

    .sort-icon span {
      display: block;
      width: 3px;
      background: currentColor;
      border-radius: 1px;
      transition: height 0.2s ease;
    }

    .sort-icon span:nth-child(1) { height: 12px; }
    .sort-icon span:nth-child(2) { height: 8px; }
    .sort-icon span:nth-child(3) { height: 4px; }

    .sort-dropdown.asc .sort-icon span:nth-child(1) { height: 4px; }
    .sort-dropdown.asc .sort-icon span:nth-child(3) { height: 12px; }

    .sort-dropdown-text {
      flex: 1;
    }

    .sort-menu {
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      min-width: 160px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-visible);
      border-radius: 10px;
      padding: 6px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 100;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .sort-menu.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .sort-menu-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .sort-menu-item:hover {
      background: var(--bg-hover);
      color: var(--text-prose);
    }

    .sort-menu-item.active {
      background: rgba(255, 255, 255, 0.06);
      color: var(--text-primary);
    }

    .sort-menu-item .check-icon {
      width: 14px;
      height: 14px;
      opacity: 0;
      color: var(--green);
    }

    .sort-menu-item.active .check-icon {
      opacity: 1;
    }

    .insight-stats {
      display: flex;
      gap: 48px;
      margin-bottom: 48px;
      align-items: baseline;
    }

    .insight-stat {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .insight-stat-value {
      font-size: 2.8rem;
      font-weight: 200;
      font-variant-numeric: tabular-nums;
      line-height: 1;
      letter-spacing: -0.03em;
      color: var(--text-prose);
    }

    .insight-stat-value.green { color: var(--green); }
    .insight-stat-value.amber { color: var(--amber); }
    .insight-stat-value.red { color: var(--red); }

    .insight-stat-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .insight-stat-value-row {
      display: flex;
      align-items: baseline;
    }

    .insight-stat-desc {
      display: inline-flex;
      align-items: baseline;
      max-width: 0;
      opacity: 0;
      overflow: hidden;
      white-space: nowrap;
      font-size: 0.85rem;
      font-weight: 300;
      color: var(--text-secondary);
      margin-left: 0;
      transition: max-width 0.3s cubic-bezier(0.16, 1, 0.3, 1), 
                  opacity 0.2s ease, 
                  margin-left 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .insight-stat:hover .insight-stat-desc {
      max-width: 180px;
      opacity: 1;
      margin-left: 12px;
    }

    @keyframes countUpFade {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .insight-stat-value.animate-in {
      animation: countUpFade 0.5s ease-out forwards;
    }

    .insight-stat-value.pre-animate {
      opacity: 0;
    }

    .insight-section-label {
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .insight-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .insight-card {
      display: flex;
      flex-direction: column;
      padding: 0;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.25s var(--ease-out-expo);
      overflow: hidden;
    }

    .insight-card:hover {
      border-color: var(--border-visible);
      background: var(--bg-hover);
    }

    .insight-card.expanded {
      background: var(--bg-hover);
      border-color: rgba(255, 255, 255, 0.12);
    }

    .insight-card-main {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px 20px;
    }

    .insight-score {
      display: flex;
      align-items: baseline;
      flex-shrink: 0;
      min-width: 64px;
    }

    .insight-score-num {
      font-size: 2rem;
      font-weight: 200;
      line-height: 1;
      letter-spacing: -0.02em;
      font-variant-numeric: tabular-nums;
    }

    .insight-score-unit {
      font-size: 0.75rem;
      font-weight: 400;
      opacity: 0.5;
      margin-left: 2px;
    }

    .insight-score.green .insight-score-num { color: var(--green); }
    .insight-score.green .insight-score-unit { color: var(--green); }
    .insight-score.amber .insight-score-num { color: var(--amber); }
    .insight-score.amber .insight-score-unit { color: var(--amber); }
    .insight-score.red .insight-score-num { color: var(--red); }
    .insight-score.red .insight-score-unit { color: var(--red); }

    .insight-card-content {
      flex: 1;
      min-width: 0;
    }

    .insight-card-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .insight-card-desc {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 300;
      line-height: 1.5;
    }

    .insight-card-meta {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .insight-meta-badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      background: var(--bg-active);
      color: var(--text-secondary);
    }

    .insight-card-expand {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      font-size: 14px;
      font-weight: 300;
      color: var(--text-tertiary);
      transition: transform 0.25s var(--ease-out-expo), color 0.15s ease;
      align-self: center;
      margin-left: auto;
    }

    .insight-card:hover .insight-card-expand {
      color: var(--text-secondary);
    }

    .insight-card.expanded .insight-card-expand {
      transform: rotate(45deg);
      color: var(--text-prose);
    }

    .insight-expanded {
      padding: 0 20px 0;
      border-top: 1px solid var(--border-subtle);
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.35s cubic-bezier(0.16, 1, 0.3, 1),
                  opacity 0.25s ease,
                  padding 0.3s ease;
    }

    .insight-card.expanded .insight-expanded {
      max-height: 500px;
      opacity: 1;
      padding: 0 20px 16px;
    }

    .expanded-section {
      padding-top: 16px;
    }

    .expanded-section-label {
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .insight-file-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .insight-file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      font-family: var(--font-mono);
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .insight-file-item:hover {
      background: var(--bg-elevated);
      color: var(--blue);
    }

    .expanded-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .expanded-input {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding: 10px 12px;
      background: var(--bg-deep);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
    }

    .expanded-input .arrow {
      color: var(--text-muted);
      font-size: 11px;
    }

    .expanded-input input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-size: 12px;
      font-weight: 300;
      color: var(--text-prose);
    }

    .expanded-input input::placeholder {
      color: var(--text-tertiary);
    }

    .scroll-indicator {
      display: none;
      position: absolute;
      bottom: 12px;
      right: 12px;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: scale(0.8) translateY(8px);
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 10;
    }

    .insight-card.expanded .insight-expanded.has-more .scroll-indicator {
      opacity: 1;
      visibility: visible;
      transform: scale(1) translateY(0);
      transition-delay: 0.3s;
    }

    .scroll-indicator svg {
      width: 16px;
      height: 16px;
      color: var(--text-secondary);
      animation: bounceArrow 2s ease-in-out infinite;
      animation-delay: 0.5s;
    }

    @keyframes bounceArrow {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(4px);
      }
      60% {
        transform: translateY(2px);
      }
    }

    .insight-expanded.has-more::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(to bottom, transparent 0%, var(--bg-hover) 100%);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease 0.3s;
    }

    .insight-card.expanded .insight-expanded.has-more::after {
      opacity: 0.6;
    }

    .insight-expanded {
      position: relative;
    }

    .insight-list {
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    .activity-view {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg-deep);
      padding: 24px;
      gap: 24px;
      overflow: hidden;
    }

    .activity-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .activity-title-area {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .activity-title {
      font-size: 1.8rem;
      font-weight: 200;
      color: var(--text-bright);
      letter-spacing: -0.01em;
    }

    .activity-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 300;
      line-height: 1.6;
    }

    .activity-stats {
      display: flex;
      gap: 24px;
    }

    .activity-stat {
      text-align: right;
    }

    .activity-stat-value {
      font-size: 1.8rem;
      font-weight: 200;
      color: var(--text-white);
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }

    .activity-stat-label {
      font-size: 0.6rem;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-top: 4px;
    }

    .activity-progress {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.015);
      border: none;
      border-radius: 12px;
      flex-shrink: 0;
      margin-bottom: 8px;
    }

    .activity-progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .activity-progress-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      color: var(--text-primary);
    }

    .activity-progress-title .working-dot {
      width: 8px;
      height: 8px;
      background: var(--green);
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
      animation: pulse 1.5s ease infinite;
    }

    .activity-progress-percent {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--green);
      font-variant-numeric: tabular-nums;
    }

    .activity-progress-bar {
      height: 4px;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 2px;
      overflow: hidden;
    }

    .activity-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.5));
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s ease;
    }

    .activity-progress-detail {
      font-size: 0.7rem;
      color: var(--text-secondary);
      font-family: var(--font-mono);
    }

    .activity-stream {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
      padding: 12px 8px 32px 0;
      position: relative;

      mask-image: linear-gradient(
        to bottom,
        rgba(0,0,0,0.3) 0%,
        black 24px,
        black calc(100% - 24px),
        rgba(0,0,0,0.3) 100%
      );
    }

    .activity-stream::-webkit-scrollbar { width: 4px; }
    .activity-stream::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.06); border-radius: 2px; }

    .activity-task {
      position: relative;
      background: rgba(255, 255, 255, 0.015);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 10px;
      overflow: hidden;
      opacity: 0;
      transform: translateY(8px);
      animation: taskSlideIn 0.4s var(--ease-out-expo) forwards;
      animation-delay: calc(var(--index, 0) * 80ms);
      cursor: pointer;
      transition: border-color 0.3s ease, background 0.3s ease, max-height 0.4s var(--ease-out-expo);
      flex-shrink: 0;
      min-height: 80px;
    }

    @keyframes taskSlideIn {
      to { opacity: 1; transform: translateY(0); }
    }

    .activity-task:hover {
      border-color: rgba(255, 255, 255, 0.06);
    }

    .activity-task.pending {
      opacity: 0.4;
    }

    .activity-task.pending .task-progress-fill {
      width: 0% !important;
    }

    .activity-task.active {
      border-color: rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.025);
      opacity: 1;
    }

    .activity-task.complete {
      border-color: rgba(255, 255, 255, 0.03);
      background: rgba(255, 255, 255, 0.01);
      opacity: 0.6;
    }

    .task-header {
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 18px 20px;
    }

    .task-status-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: var(--text-muted);
      transition: color 0.3s ease;
    }

    .activity-task.active .task-status-icon {
      color: var(--text-primary);
    }

    .activity-task.complete .task-status-icon {
      color: var(--text-secondary);
    }

    .task-ticker {
      position: relative;
      overflow: hidden;
      height: 24px;
      margin: 20px 0;
      padding: 5px 0;
      width: 100%;
      mask-image: linear-gradient(90deg, transparent 0%, black 2%, black 98%, transparent 100%);
      opacity: 0;
      transition: opacity 0.4s ease 0.2s;
      box-sizing: border-box;
      background: transparent;
    }

    .activity-task.expanded .task-ticker {
      opacity: 1;
    }

    .ticker-track {
      display: flex;
      gap: 48px;
      width: max-content;
      animation: tickerScroll 50s linear infinite;
      padding: 0;
    }

    @keyframes tickerScroll {
      from { transform: translateX(0); }
      to { transform: translateX(-50%); }
    }

    .ticker-track span {
      font-size: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-muted);
      opacity: 0.5;
      white-space: nowrap;
      font-weight: 300;
    }

    .task-prose {
      font-size: 0.8rem;
      font-weight: 300;
      line-height: 1.7;
      color: var(--text-prose);
      letter-spacing: 0.01em;
      padding: 0 28px 16px;
      opacity: 0;
      transform: translateY(-4px);
      transition: opacity 0.3s ease 0.15s, transform 0.3s ease 0.15s;
    }

    .activity-task.expanded .task-prose {
      opacity: 1;
      transform: translateY(0);
    }

    .task-info {
      flex: 1;
      min-width: 0;
    }

    .task-title {
      font-size: 0.85rem;
      font-weight: 400;
      color: var(--text-primary);
      margin-bottom: 4px;
      letter-spacing: -0.01em;
    }

    .task-file {
      font-size: 0.7rem;
      font-family: var(--font-mono);
      color: var(--text-tertiary);
    }

    .task-expand-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 200;
      transition: transform 0.3s var(--ease-out-expo), color 0.2s;
    }

    .task-expand-btn:hover {
      color: var(--text-secondary);
    }

    .activity-task.expanded .task-expand-btn {
      transform: rotate(45deg);
      color: var(--text-secondary);
    }

    .task-progress {
      padding: 0 18px 14px;
    }

    .task-progress-bar {
      height: 2px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 1px;
      overflow: hidden;
    }

    .task-progress-fill {
      height: 100%;
      width: 0%;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 1px;
      transition: width 0.1s linear;
    }

    .activity-task.complete .task-progress-fill {
      width: 100% !important;
      background: rgba(255, 255, 255, 0.4);
    }

    .task-dialogue {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s var(--ease-out-expo), opacity 0.3s;
      opacity: 0;
    }

    .activity-task.expanded .task-dialogue {
      max-height: 450px;
      opacity: 1;
    }

    .task-dialogue-inner {
      padding: 8px 28px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 200px;
      overflow-y: auto;
      mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
    }

    .task-dialogue-inner::-webkit-scrollbar { width: 3px; }
    .task-dialogue-inner::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.04); }

    .task-input-area {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 16px 28px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.03);
    }

    .task-input-arrow {
      color: var(--text-muted);
      font-size: 0.75rem;
      opacity: 0.5;
    }

    .task-input-field {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-family: inherit;
      font-size: 0.8rem;
      color: var(--text-secondary);
      letter-spacing: 0.01em;
    }

    .task-input-field::placeholder {
      color: var(--text-muted);
      opacity: 0.6;
    }

    .task-input-hint {
      font-size: 0.55rem;
      color: var(--text-muted);
      opacity: 0.6;
    }

    .task-input-hint kbd {
      background: rgba(255, 255, 255, 0.06);
      padding: 2px 5px;
      border-radius: 3px;
    }

    .agent-msg {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      font-size: 0.82rem;
      font-weight: 300;
      color: var(--text-prose);
      line-height: 1.8;
      letter-spacing: 0.015em;
      opacity: 0;
      animation: agentMsgFadeIn 0.3s ease forwards;
      padding: 8px 0;
    }

    @keyframes agentMsgFadeIn {
      to { opacity: 1; }
    }

    .agent-msg:nth-last-child(1) { opacity: 1; }
    .agent-msg:nth-last-child(2) { opacity: 0.7; }
    .agent-msg:nth-last-child(3) { opacity: 0.5; }
    .agent-msg:nth-last-child(n+4) { opacity: 0.3; }

    .agent-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 8px;
    }

    .agent-msg.agent-1 .agent-dot { background: var(--purple); }
    .agent-msg.agent-2 .agent-dot { background: var(--blue); }
    .agent-msg.agent-3 .agent-dot { background: var(--green); }

    .agent-msg-text {
      flex: 1;
      min-width: 0;
    }

    .agent-msg-text code {
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 7px;
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 0.88em;
      color: var(--text-primary);
    }

    .typing-cursor {
      display: inline-block;
      width: 1px;
      height: 1em;
      background: var(--text-tertiary);
      margin-left: 2px;
      animation: typingBlink 1s step-end infinite;
      vertical-align: text-bottom;
    }

    @keyframes typingBlink {
      50% { opacity: 0; }
    }

    .activity-item {
      display: flex;
      gap: 14px;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      animation: activityItemIn 0.4s var(--ease-out-expo);
    }

    @keyframes activityItemIn {
      from { opacity: 0; transform: translateY(10px); }
    }

    .activity-item.complete {
      border-color: rgba(74, 222, 128, 0.15);
      background: rgba(74, 222, 128, 0.02);
    }

    .activity-item.in-progress {
      border-color: rgba(251, 191, 36, 0.15);
      background: rgba(251, 191, 36, 0.02);
    }

    .activity-item-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 8px;
      flex-shrink: 0;
    }

    .activity-item.complete .activity-item-icon {
      background: rgba(74, 222, 128, 0.1);
      color: var(--green);
    }

    .activity-item.in-progress .activity-item-icon {
      background: rgba(251, 191, 36, 0.1);
      color: var(--amber);
    }

    .activity-item-content {
      flex: 1;
      min-width: 0;
    }

    .activity-item-title {
      font-size: 0.8rem;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .activity-item-desc {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .activity-item-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    .activity-item-file {
      font-size: 0.65rem;
      font-family: var(--font-mono);
      color: var(--text-tertiary);
      background: rgba(255, 255, 255, 0.04);
      padding: 3px 8px;
      border-radius: 4px;
    }

    .activity-item-time {
      font-size: 0.6rem;
      color: var(--text-muted);
    }

    .activity-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: var(--text-tertiary);
    }

    .activity-empty-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
    }

    .activity-empty-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .activity-empty-hint {
      font-size: 0.7rem;
      color: var(--text-tertiary);
    }

    .demo-controls {
      position: fixed;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }

    .demo-btn {
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid var(--border-visible);
      background: var(--bg-surface);
      color: var(--text-prose);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .demo-btn:hover {
      background: var(--bg-hover);
      color: var(--text-bright);
    }

    .demo-btn.active {
      background: var(--green-bg);
      border-color: var(--green-border);
      color: var(--green);
    }

    .demo-btn.primary {
      background: var(--bg-hover);
      border-color: rgba(255, 255, 255, 0.15);
      color: var(--text-bright);
    }

    .demo-btn.sound-btn {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .demo-btn.sound-btn svg {
      transition: opacity 0.2s ease;
    }

    .demo-btn.sound-btn.muted svg .sound-wave {
      opacity: 0;
    }

    .demo-btn.sound-btn.muted::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 2px;
      background: var(--red);
      transform: rotate(-45deg);
      border-radius: 1px;
    }

    .demo-btn.sound-btn {
      position: relative;
    }
  </style>
</head>
<body>

  <div class="mock-cursor" id="mock-cursor" style="left: -50px; top: -50px;">
    <svg viewBox="0 0 24 24" fill="none">
      <path d="M4 4L12 20L14 14L20 12L4 4Z" fill="white" stroke="black" stroke-width="1"/>
    </svg>
  </div>

  <div class="narration-bar" id="narration-bar">
    <div class="narration-text" id="narration-text"></div>
  </div>

  <div class="screen active" id="analysis-screen">

    <div class="analysis-status">
      <div class="logo">Lattice</div>
      <div class="status-headline visible" id="status-headline">
        Ready to analyze your codebase.
      </div>
      <div class="ascii-progress" id="ascii-progress">
        <div class="ascii-bar" id="ascii-bar"></div>
        <div class="ascii-status">
          scanning <span class="current-file" id="current-file"></span>
        </div>
      </div>
    </div>

    <div class="stream-ticker" id="stream-ticker">
      <div class="ticker-row" id="ticker-row-1" style="--duration: 80s;"></div>
      <div class="ticker-row reverse" id="ticker-row-2" style="--duration: 70s;"></div>
      <div class="ticker-row" id="ticker-row-3" style="--duration: 90s;"></div>
    </div>

    <div class="agent-center" id="agent-center"></div>

    <div class="concepts-bar" id="concepts-bar">
      <span class="concepts-label">Detected</span>
      <div class="concepts-list" id="concepts-list"></div>
    </div>

    <div class="hint-bar">
      <span><kbd>Space</kbd> Skip</span>
    </div>

    <button class="analysis-play-btn" id="analysis-play-btn">
      <kbd>Enter</kbd>
      Begin Analysis
    </button>
  </div>

  <div class="screen" id="dashboard-screen">
    <div class="report-container">
      <div class="report-document">

        <div class="report-header">
          <div class="report-logo">Lattice</div>
          <div class="report-title">Analysis Complete</div>
        </div>

        <p class="analysis-text">
          Scanned <span class="highlight">47 files</span> across your React codebase and identified a 
          <span class="inline-badge amber" data-key="1"><span class="badge-key">1</span>fragmentation index</span> 
          of 0.73 in your visual layer. Cross-referencing against the 
          <span class="inline-badge blue" data-key="2"><span class="badge-key">2</span>coherence graph</span> 
          revealed <span class="highlight">14 redundant color definitions</span> and 
          <span class="highlight">23 spacing inconsistencies</span> propagating through nested structures.
        </p>

        <p class="analysis-text">
          Based on entropy scoring and downstream impact analysis, consolidating your design primitives 
          into a single source of truth would reduce 
          <span class="inline-badge green" data-key="3"><span class="badge-key">3</span>visual drift</span> 
          by an estimated <span class="highlight">70%</span>. 
          <span class="highlight">47 components</span> would auto-correct once tokens are unified.
        </p>

        <div class="report-actions">
          <button class="report-action-btn" id="report-btn-editor">
            <span>Open Editor</span>
            <kbd>E</kbd>
          </button>
          <button class="report-action-btn" id="report-btn-features">
            <span>Features</span>
            <kbd>F</kbd>
          </button>
          <button class="report-action-btn" id="report-btn-tech-debt">
            <span>Tech Debt</span>
            <kbd>T</kbd>
          </button>
          <button class="report-action-btn" id="report-btn-tests">
            <span>Tests</span>
            <kbd>S</kbd>
          </button>
        </div>
      </div>
    </div>

    <div class="dashboard-hint-bar">
      <span><kbd>1</kbd><kbd>2</kbd><kbd>3</kbd> Explore topics</span>
      <span><kbd>E</kbd> Editor</span>
      <span><kbd>esc</kbd> Close</span>
    </div>
  </div>

  <div class="screen" id="editor-screen">

    <div class="status-island" id="status-island">
      <div class="status-dot" id="status-dot"></div>
      <span class="status-text" id="status-text">Ready</span>
      <div class="status-progress" id="status-progress" style="display: none;">
        <div class="status-progress-fill" id="status-progress-fill" style="width: 0%"></div>
      </div>
    </div>

    <div class="app">

    <nav class="nav-bar">
      <button class="nav-tab active" id="tab-editor" data-tab="editor">Editor</button>
      <button class="nav-tab" id="tab-features" data-tab="features">Features</button>
      <button class="nav-tab" id="tab-tech-debt" data-tab="tech-debt">Tech Debt</button>
      <button class="nav-tab" id="tab-tests" data-tab="tests">Tests</button>
      <button class="nav-tab" id="tab-activity" data-tab="activity">
        Activity
        <span class="activity-indicator"></span>
      </button>

      <div class="command-bar">
        <div class="command-stat warning">
          <span>Issues</span>
          <span class="command-stat-value" id="issues-value">14</span>
        </div>
        <button class="fix-all-btn" id="fix-all-btn">
          <kbd id="fix-kbd">F</kbd>
          <span class="fix-text">Fix All Issues</span>
        </button>
      </div>
    </nav>

    <div class="content">

      <div class="panel panel-left" id="panel-left">
        <div class="panel-header">
          <button class="panel-tab active">All Files</button>
        </div>
        <div class="panel-content" id="file-tree">

        </div>
      </div>

      <div class="panel panel-center" id="panel-center">

      </div>

      <div class="panel panel-right" id="panel-right">
        <div class="chat-messages" id="chat-messages">
          <div class="chat-empty">
            <div class="chat-empty-label">Lattice Agent</div>
            <div class="chat-empty-hint">Ask about your codebase...</div>
          </div>
        </div>
        <div class="chat-input">
          <span class="arrow">â†’</span>
          <input type="text" placeholder="Ask about this codebase..." id="chat-input">
          <span class="hint"><kbd>â†µ</kbd></span>
        </div>
      </div>
    </div>
  </div>

    <div class="demo-controls">
      <button class="demo-btn primary" id="play-demo-btn">Play Demo</button>
      <button class="demo-btn" id="restart-btn">Restart</button>
      <button class="demo-btn sound-btn" id="sound-toggle"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path class="sound-wave" d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></button>
    </div>
  </div>

  <audio id="sound-startup" src="client/public/sounds/01 Startup.mp3" preload="auto"></audio>
  <audio id="sound-cursor" src="client/public/sounds/05 SFX Cursor.mp3" preload="auto"></audio>
  <audio id="sound-decide" src="client/public/sounds/06 SFX Decide.mp3" preload="auto"></audio>
  <audio id="sound-cancel" src="client/public/sounds/03 SFX Cancel.mp3" preload="auto"></audio>
  <audio id="sound-confirm" src="client/public/sounds/09 SFX System Ok.mp3" preload="auto"></audio>
  <audio id="sound-tab" src="client/public/sounds/04 SFX Category Decide.mp3" preload="auto"></audio>
  <audio id="sound-category" src="client/public/sounds/04 SFX Category Decide.mp3" preload="auto"></audio>
  <audio id="sound-option" src="client/public/sounds/07 SFX Option.mp3" preload="auto"></audio>

  <script>

    let soundEnabled = true;
    let demoRunning = false;
    let demoPaused = false;
    let currentTab = 'editor';
    let demoTimeouts = [];
    let expandedCards = new Set();

    const tabsFirstOpened = { features: false, 'tech-debt': false, tests: false };

    let currentScreen = 'analysis';
    let analysisRunning = false;
    let analysisComplete = false;
    let analysisInterval = null;
    let agentMessageIndex = 0;

    const analysisFiles = [
      'package.json', 'tsconfig.json', 'src/index.tsx', 'src/App.tsx',
      'src/components/ChatPanel.tsx', 'src/components/FilePanel.tsx',
      'src/components/CodeEditor.tsx', 'src/services/auth.ts',
      'src/services/api.ts', 'src/utils/formatters.ts', 'src/utils/session.ts',
      'src/hooks/useTheme.ts', 'src/styles/theme.ts', 'src/components/Button.tsx',
      'src/components/Card.tsx', 'src/components/Modal.tsx', 'src/components/Form.tsx'
    ];

    const streamDialogue = [
      { agent: 1, text: 'scanning component tree...' },
      { agent: 2, text: 'found 847 instances' },
      { agent: 3, text: 'cross-referencing theme.ts' },
      { agent: 1, text: 'duplicate color #3b82f6 detected' },
      { agent: 2, text: 'checking coherence graph' },
      { agent: 3, text: 'pattern match in Button.tsx' },
      { agent: 1, text: 'should we flag this as critical?' },
      { agent: 2, text: 'is this intentional or drift?' },
      { agent: 3, text: 'want me to trace the origin?' },
      { agent: 1, text: 'yes, confirmed - same base color' },
      { agent: 2, text: 'looks like copy-paste drift' },
      { agent: 3, text: 'no breaking changes if we merge' },
      { agent: 1, text: 'the original is in theme.ts:47' },
      { agent: 2, text: 'this one diverged 3 commits ago' },
      { agent: 3, text: 'I see 4 more instances downstream' },
      { agent: 1, text: 'interesting - hover state differs' },
      { agent: 2, text: 'spacing is off by 2px here' },
      { agent: 3, text: 'border-radius inconsistent' },
      { agent: 1, text: 'flagging for review' },
      { agent: 2, text: 'adding to coherence report' },
      { agent: 3, text: 'queueing for batch fix' },
      { agent: 1, text: 'calculating impact radius...' },
      { agent: 2, text: 'building dependency graph' },
      { agent: 3, text: 'preparing safe refactor' },
    ];

    const agentMessages = [
      { agent: 1, text: 'Scanning component tree... found <span class="highlight">847 instances</span>' },
      { agent: 2, text: 'Cross-referencing with <code>theme.ts</code>' },
      { agent: 1, text: 'Duplicate color detected: <code>#3b82f6</code> in Button.tsx' },
      { agent: 3, text: 'Checking coherence graph for patterns...' },
      { agent: 2, text: 'Match confirmed. Adding to <span class="highlight">fragmentation index</span>' },
      { agent: 1, text: 'Found spacing conflict in <code>FormInput.tsx:23</code>' },
      { agent: 3, text: 'Analyzing bundle for unused exports...' },
      { agent: 2, text: 'Token inheritance traced through 47 components' },
      { agent: 1, text: 'Calculating projected impact...' },
      { agent: 3, text: 'Tree-shaking analysis complete' },
      { agent: 2, text: 'Generating actionable insights...' },
    ];

    const detectedConcepts = ['React', 'TypeScript', 'OAuth', 'Redux', 'JWT', 'REST API'];

    const fileTree = [
      { name: 'src', type: 'folder', expanded: true, children: [
        { name: 'components', type: 'folder', expanded: true, children: [
          { name: 'App.tsx', type: 'file', score: 8.4, scoreColor: 'green' },
          { name: 'ChatPanel.tsx', type: 'file', score: 7.2, scoreColor: 'green' },
          { name: 'FilePanel.tsx', type: 'file', score: 6.8, scoreColor: 'amber' },
          { name: 'CodeEditor.tsx', type: 'file', score: 9.1, scoreColor: 'green' },
        ]},
        { name: 'utils', type: 'folder', expanded: false, children: [
          { name: 'formatters.ts', type: 'file', score: 3.2, scoreColor: 'red' },
          { name: 'validators.ts', type: 'file', score: 7.5, scoreColor: 'green' },
        ]},
        { name: 'services', type: 'folder', expanded: false, children: [
          { name: 'auth.ts', type: 'file', score: 4.1, scoreColor: 'amber' },
          { name: 'api.ts', type: 'file', score: 8.0, scoreColor: 'green' },
        ]},
      ]},
      { name: 'public', type: 'folder', expanded: false },
      { name: 'package.json', type: 'file' },
      { name: 'tsconfig.json', type: 'file' },
    ];

    const featuresData = [
      { 
        id: 'auth', 
        name: 'User Authentication', 
        score: 94, 
        color: 'green',
        desc: 'OAuth 2.0 with Google and GitHub providers, JWT session management',
        files: ['src/services/auth.ts', 'src/utils/session.ts', 'src/components/AuthPage.tsx'],
        meta: ['OAuth 2.0', 'JWT', '3 files'],
        ticker: ['security', 'session', 'tokens', 'oauth', 'jwt', 'identity', 'refresh', 'claims'],
        prose: 'Handles user identity with <strong>OAuth 2.0</strong> flows. Sessions persist via JWT tokens stored in httpOnly cookies.',
        actions: [{ key: 'D', label: 'View diagram', primary: false }, { key: 'T', label: 'Run tests', primary: true }]
      },
      { 
        id: 'files', 
        name: 'File Management', 
        score: 87, 
        color: 'green',
        desc: 'Upload, preview, and organize files with drag-and-drop support',
        files: ['src/components/FilePanel.tsx', 'src/services/storage.ts'],
        meta: ['Drag & Drop', '2 files'],
        ticker: ['upload', 'preview', 's3', 'blob', 'mime', 'drag', 'bucket', 'stream'],
        prose: 'Complete file handling with <strong>drag-and-drop</strong> uploads and real-time preview.',
        actions: [{ key: 'F', label: 'Open FilePanel', primary: true }]
      },
      { 
        id: 'realtime', 
        name: 'Real-time Collaboration', 
        score: 72, 
        color: 'amber',
        desc: 'WebSocket-based live editing with conflict resolution',
        files: ['src/services/websocket.ts', 'src/utils/crdt.ts', 'src/hooks/useCollaboration.ts'],
        meta: ['WebSocket', 'CRDT', '3 files'],
        ticker: ['sync', 'collab', 'crdt', 'websocket', 'yjs', 'merge', 'cursor', 'presence'],
        prose: 'Live collaboration via <strong>WebSocket</strong>. CRDT ensures conflict-free merges.',
        actions: [{ key: 'I', label: 'Improve score', primary: true }, { key: '?', label: 'Why 72%' }]
      },
      { 
        id: 'export', 
        name: 'Export API', 
        score: 45, 
        color: 'red',
        desc: 'Export data in various formats, limited error handling',
        files: ['src/services/export.ts'],
        meta: ['Needs work', '1 file'],
        ticker: ['json', 'csv', 'pdf', 'xlsx', 'format', 'download', 'serialize', 'blob'],
        prose: 'Basic export functionality. Missing <strong>error boundaries</strong> and format validation.',
        actions: [{ key: 'F', label: 'Fix issues', primary: true }, { key: 'R', label: 'Refactor' }]
      },
    ];

    const techDebtData = [
      {
        id: 'formatters',
        name: 'utils/formatters.ts',
        score: 3,
        color: 'red',
        desc: 'No type safety, uses any extensively, missing error boundaries',
        issues: ['any types', 'no tests', 'dead code'],
        ticker: ['types', 'safety', 'testing', 'coverage', 'any', 'infer', 'generic', 'strict'],
        prose: 'Heavy use of <code>any</code> types bypasses TypeScript safety. <strong>12 functions</strong> lack proper typing.',
        actions: [{ key: 'F', label: 'Add types', primary: true }, { key: 'D', label: 'View diff' }]
      },
      {
        id: 'auth',
        name: 'services/auth.ts',
        score: 4,
        color: 'amber',
        desc: 'Deprecated OAuth flow, should migrate to next-auth',
        issues: ['deprecated API', 'sync calls'],
        ticker: ['oauth', 'migration', 'async', 'nextauth', 'callback', 'session', 'provider', 'refresh'],
        prose: 'Using <strong>deprecated OAuth 1.0</strong> patterns. Migrate to <code>next-auth</code> for better security.',
        actions: [{ key: 'M', label: 'Migrate', primary: true }, { key: '?', label: 'Why migrate' }]
      },
      {
        id: 'filepanel',
        name: 'components/FilePanel.tsx',
        score: 6,
        color: 'amber',
        desc: 'Modal accessibility issues, missing ARIA labels',
        issues: ['a11y', 'large component'],
        ticker: ['aria', 'a11y', 'modal', 'focus', 'trap', 'escape', 'label', 'role'],
        prose: 'Missing <strong>ARIA labels</strong> on interactive elements. Modal lacks proper focus management.',
        actions: [{ key: 'A', label: 'Fix a11y', primary: true }]
      },
      {
        id: 'chatpanel',
        name: 'components/ChatPanel.tsx',
        score: 7,
        color: 'green',
        desc: 'Good structure, minor performance optimizations possible',
        issues: ['memo opportunities'],
        ticker: ['memo', 'perf', 'render', 'usecallback', 'virtual', 'profiler', 'batch', 'lazy'],
        prose: 'Well structured. Consider <code>useMemo</code> for message list to reduce re-renders.',
        actions: [{ key: 'O', label: 'Optimize', primary: true }]
      },
    ];

    const testsData = [
      { name: 'components/', score: 84, color: 'green', coverage: '84%', tests: 42, 
        desc: 'Strong coverage. Missing edge cases in modal interactions.',
        files: ['App.test.tsx', 'ChatPanel.test.tsx', 'FilePanel.test.tsx'] },
      { name: 'utils/', score: 91, color: 'green', coverage: '91%', tests: 28,
        desc: 'Excellent coverage. All utility functions well tested.',
        files: ['formatters.test.ts', 'validators.test.ts'] },
      { name: 'services/', score: 67, color: 'amber', coverage: '67%', tests: 15,
        desc: 'Auth service needs more integration tests.',
        files: ['auth.test.ts', 'api.test.ts'] },
      { name: 'hooks/', score: 42, color: 'red', coverage: '42%', tests: 8,
        desc: 'Critical gap. Custom hooks lack proper testing.',
        files: ['useCollaboration.test.ts'] },
    ];

    let lastSoundTime = {};
    const SOUND_DEBOUNCE = 80; // ms

    function playSound(name) {
      if (!soundEnabled) return;

      const now = Date.now();
      if (lastSoundTime[name] && now - lastSoundTime[name] < SOUND_DEBOUNCE) {
        return;
      }
      lastSoundTime[name] = now;

      const audio = document.getElementById(`sound-${name}`);
      if (audio) {

        const clone = audio.cloneNode();
        clone.volume = 0.12;
        clone.play().catch(() => {});

        clone.onended = () => clone.remove();
      }
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      const btn = document.getElementById('sound-toggle');
      btn.classList.toggle('muted', !soundEnabled);
    }

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(`${screenId}-screen`).classList.add('active');
      currentScreen = screenId;
    }

    function initStreamTicker() {
      const rows = [
        document.getElementById('ticker-row-1'),
        document.getElementById('ticker-row-2'),
        document.getElementById('ticker-row-3'),
      ];

      rows.forEach((row, rowIndex) => {
        if (!row) return;
        const content = document.createElement('div');
        content.className = 'ticker-content';

        for (let i = 0; i < 2; i++) {
          streamDialogue.forEach(item => {
            const tickerItem = document.createElement('span');
            tickerItem.className = `ticker-item agent-${item.agent}`;
            tickerItem.innerHTML = `<span class="agent-dot"></span>${item.text}`;
            content.appendChild(tickerItem);
          });
        }

        row.appendChild(content);
      });
    }

    const ANALYSIS_DURATION = 22000; // 22 seconds
    const BAR_WIDTH = 20;
    let analysisStartTime = null;

    function updateAsciiBar(progress) {
      const asciiBar = document.getElementById('ascii-bar');
      const currentFile = document.getElementById('current-file');
      if (!asciiBar || !currentFile) return;

      const percent = Math.round(progress * 100);
      const filled = Math.round(progress * BAR_WIDTH);

      const filledStr = '\u2588'.repeat(filled);
      const emptyStr = '\u2591'.repeat(BAR_WIDTH - filled);

      asciiBar.innerHTML = `<span class="filled">${filledStr}</span>${emptyStr} ${percent}%`;

      const fileIndex = Math.floor(progress * analysisFiles.length);
      if (fileIndex < analysisFiles.length) {
        currentFile.textContent = analysisFiles[fileIndex];
      }
    }

    function updateHeadline(progress) {
      const headline = document.getElementById('status-headline');
      if (!headline) return;
      const headlines = [
        'Scanning file structure...',
        'Analyzing dependencies...',
        'Mapping component tree...',
        'Detecting patterns...',
        'Cross-referencing tokens...',
        'Calculating surfaces...',
        'Generating insights...',
        'Finalizing analysis...',
      ];
      const idx = Math.min(Math.floor(progress * headlines.length), headlines.length - 1);
      headline.innerHTML = headlines[idx];
    }

    async function addAgentMessage() {
      if (agentMessageIndex >= agentMessages.length) return;

      const container = document.getElementById('agent-center');
      if (!container) return;
      const msg = agentMessages[agentMessageIndex];
      agentMessageIndex++;

      const messages = container.querySelectorAll('.agent-message');
      if (messages.length >= 4) {
        const oldest = messages[0];
        oldest.classList.add('fading');
        await new Promise(r => setTimeout(r, 300));
        oldest.remove();
      }

      const msgEl = document.createElement('div');
      msgEl.className = `agent-message agent-${msg.agent}`;
      msgEl.innerHTML = `
        <div class="agent-badge"><span class="dot"></span>Agent ${msg.agent}</div>
        <div class="agent-text">${msg.text}</div>
      `;
      container.appendChild(msgEl);
      playSound('confirm');
    }

    function addConcept(concept) {
      const conceptsList = document.getElementById('concepts-list');
      if (!conceptsList) return;
      const tag = document.createElement('span');
      tag.className = 'concept-tag';
      tag.textContent = concept;
      conceptsList.appendChild(tag);
    }

    async function runAnalysis() {
      if (analysisRunning) return;
      analysisRunning = true;
      analysisComplete = false;
      agentMessageIndex = 0;

      const playBtn = document.getElementById('analysis-play-btn');
      if (playBtn) playBtn.classList.add('hidden');

      const asciiProgress = document.getElementById('ascii-progress');
      const streamTicker = document.getElementById('stream-ticker');
      if (asciiProgress) asciiProgress.classList.add('visible');
      if (streamTicker) streamTicker.classList.add('visible');

      playSound('startup');

      analysisStartTime = Date.now();

      for (let i = 0; i < agentMessages.length; i++) {
        setTimeout(() => {
          addAgentMessage();
        }, 2000 + i * 1800);
      }

      setTimeout(() => {
        const conceptsBar = document.getElementById('concepts-bar');
        if (conceptsBar) conceptsBar.classList.add('visible');
        detectedConcepts.forEach((c, i) => setTimeout(() => addConcept(c), i * 400));
      }, 8000);

      analysisInterval = setInterval(() => {
        const elapsed = Date.now() - analysisStartTime;
        const progress = Math.min(elapsed / ANALYSIS_DURATION, 1);
        updateAsciiBar(progress);
        updateHeadline(progress);

        if (progress >= 1) {
          clearInterval(analysisInterval);
          finishAnalysis();
        }
      }, 50);
    }

    function finishAnalysis() {
      analysisComplete = true;
      analysisRunning = false;

      setTimeout(() => {
        showScreen('dashboard');
        playSound('category');
      }, 1000);
    }

    function skipAnalysis() {
      if (analysisInterval) clearInterval(analysisInterval);
      analysisComplete = true;
      analysisRunning = false;
      showScreen('dashboard');
      playSound('category');
    }

    function createParticles() {
      const analysisScreen = document.getElementById('analysis-screen');
      if (!analysisScreen) return;

      const container = document.createElement('div');
      container.className = 'particles-container';
      analysisScreen.appendChild(container);

      for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'ambient-particle';
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.animationDuration = `${20 + Math.random() * 20}s`;
        particle.style.animationDelay = `${Math.random() * 20}s`;
        particle.style.setProperty('--drift', `${(Math.random() - 0.5) * 100}px`);
        container.appendChild(particle);
      }
    }

    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('mousemove', (e) => {
        const rect = tab.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        tab.style.setProperty('--glow-x', `${x}%`);
      });

      tab.addEventListener('mouseleave', () => {
        tab.style.setProperty('--glow-x', '50%');
      });
    });

    function moveCursor(x, y, duration = 800) {
      return new Promise(resolve => {
        const cursor = document.getElementById('mock-cursor');
        cursor.style.transitionDuration = `${duration}ms`;
        cursor.style.left = `${x}px`;
        cursor.style.top = `${y}px`;
        setTimeout(resolve, duration + 50);
      });
    }

    function moveCursorToElement(selector, offsetX = 0, offsetY = 0, duration = 800) {
      return new Promise(resolve => {
        const el = document.querySelector(selector);
        if (!el) { resolve(); return; }
        const rect = el.getBoundingClientRect();
        moveCursor(rect.left + rect.width/2 + offsetX, rect.top + rect.height/2 + offsetY, duration)
          .then(resolve);
      });
    }

    function clickCursor() {
      return new Promise(resolve => {
        const cursor = document.getElementById('mock-cursor');
        cursor.classList.add('clicking');

        const ripple = document.createElement('div');
        ripple.className = 'click-ripple';
        ripple.style.left = `${parseInt(cursor.style.left) - 5}px`;
        ripple.style.top = `${parseInt(cursor.style.top) - 5}px`;
        document.body.appendChild(ripple);

        setTimeout(() => {
          cursor.classList.remove('clicking');
          ripple.remove();
          resolve();
        }, 400);
      });
    }

    function showNarration(text, duration = 3000) {
      return new Promise(resolve => {
        const bar = document.getElementById('narration-bar');
        const textEl = document.getElementById('narration-text');
        textEl.innerHTML = text;
        bar.classList.add('visible');

        setTimeout(() => {
          bar.classList.remove('visible');
          setTimeout(resolve, 500);
        }, duration);
      });
    }

    function hideNarration() {
      document.getElementById('narration-bar').classList.remove('visible');
    }

    function showStatus(text, progress = null) {
      const island = document.getElementById('status-island');
      const dot = document.getElementById('status-dot');
      const textEl = document.getElementById('status-text');
      const progressBar = document.getElementById('status-progress');
      const progressFill = document.getElementById('status-progress-fill');

      textEl.textContent = text;
      dot.classList.add('active');
      island.classList.add('visible');
      island.classList.remove('success');

      if (progress !== null) {
        progressBar.style.display = 'block';
        progressFill.style.width = `${progress}%`;
      } else {
        progressBar.style.display = 'none';
      }
    }

    function updateStatusProgress(progress) {
      document.getElementById('status-progress-fill').style.width = `${progress}%`;
    }

    function showStatusSuccess(text) {
      const island = document.getElementById('status-island');
      document.getElementById('status-text').textContent = text;
      document.getElementById('status-progress').style.display = 'none';
      island.classList.add('success');
      playSound('confirm');
    }

    function hideStatus() {
      document.getElementById('status-island').classList.remove('visible');
    }

    function renderFileTree() {
      const container = document.getElementById('file-tree');
      container.innerHTML = renderFileNode(fileTree, 0);
    }

    function renderFileNode(items, depth) {
      return items.map(item => {
        if (item.type === 'folder') {
          const icon = item.expanded ? 'â–¾' : 'â–¸';
          const children = item.expanded && item.children ? 
            `<div class="nested">${renderFileNode(item.children, depth + 1)}</div>` : '';
          return `
            <div class="file-item folder-item" style="padding-left: ${12 + depth * 12}px">
              <span><span class="icon">${icon}</span> ${item.name}</span>
            </div>
            ${children}
          `;
        } else {
          const badge = item.score ? 
            `<span class="file-badge ${item.scoreColor}">${item.score}</span>` : '';
          return `
            <div class="file-item" data-file="${item.name}" style="padding-left: ${16 + depth * 12}px">
              <span>${item.name}</span>
              ${badge}
            </div>
          `;
        }
      }).join('');
    }

    function switchTab(tabName) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');
      currentTab = tabName;
      expandedCards.clear();

      const panelCenter = document.getElementById('panel-center');

      switch(tabName) {
        case 'editor':
          panelCenter.innerHTML = getEditorContent();
          setupStatCardInteractions();
          break;
        case 'features':
          panelCenter.innerHTML = getFeaturesContent();
          setupCardInteractions();
          setupSortDropdowns();
          setupScrollIndicators();
          break;
        case 'tech-debt':
          panelCenter.innerHTML = getTechDebtContent();
          setupCardInteractions();
          setupSortDropdowns();
          setupScrollIndicators();
          break;
        case 'tests':
          panelCenter.innerHTML = getTestsContent();
          setupCardInteractions();
          setupSortDropdowns();
          setupScrollIndicators();
          break;
        case 'activity':
          panelCenter.innerHTML = getActivityContent();
          setupTaskCardInteractions();
          break;
      }

      playSound('tab');

      if (['features', 'tech-debt', 'tests'].includes(tabName) && !tabsFirstOpened[tabName]) {
        tabsFirstOpened[tabName] = true;
        animateInsightStats();
      }
    }

    function animateInsightStats() {
      const statValues = document.querySelectorAll('.insight-stat-value');

      statValues.forEach((el, index) => {
        const originalText = el.textContent;
        const targetValue = parseFloat(originalText.replace(/[^0-9.]/g, ''));
        const suffix = originalText.replace(/[0-9.]/g, ''); // Extract %, etc.
        const isDecimal = originalText.includes('.');

        el.textContent = '0' + suffix;
        el.classList.add('pre-animate');

        setTimeout(() => {
          el.classList.remove('pre-animate');
          el.classList.add('animate-in');

          const duration = 800;
          const startTime = performance.now();

          function updateNumber(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            const eased = 1 - Math.pow(1 - progress, 3);
            const currentValue = targetValue * eased;

            if (isDecimal) {
              el.textContent = currentValue.toFixed(1) + suffix;
            } else {
              el.textContent = Math.round(currentValue) + suffix;
            }

            if (progress < 1) {
              requestAnimationFrame(updateNumber);
            } else {

              el.textContent = originalText;
            }
          }

          requestAnimationFrame(updateNumber);
        }, index * 150); // Stagger by 150ms
      });
    }

    let activityItems = [];
    let fixAllInProgress = false;
    let activityTaskStates = {}; // Track individual task states: { taskIndex: { progress: 0, status: 'pending' } }

    let activeDashboardAnnotation = null;
    let activeDashboardElement = null;

    const dashboardCardData = {
      '1': {
        color: 'amber',
        title: 'Fragmentation Index',
        stat: '0.73',
        statTarget: 0.73,
        statSup: '/ 1.0',
        isDecimal: true,
        ticker: ['entropy', 'variance', 'dispersion', 'inconsistency', 'fragmentation', 'drift', 'patterns', 'conflicts'],
        prose: 'Above the <strong>0.5 threshold</strong> for visual coherence. Token entropy suggests <em>multiple competing design patterns</em> across your component library.',
        actions: [
          { key: 'F', label: 'Fix highest impact', primary: true },
          { key: '?', label: 'Why 0.5' }
        ],
        placeholder: 'Ask about fragmentation...',
        responses: { 
          'why': 'The 0.5 threshold comes from information theory â€” above this point, visual noise outweighs signal.',
          'default': 'This measures design system entropy. Lower is better.' 
        }
      },
      '2': {
        color: 'blue',
        title: 'Coherence Graph',
        stat: '37',
        statTarget: 37,
        statSup: 'conflicts',
        isDecimal: false,
        ticker: ['colors', 'spacing', 'typography', 'shadows', 'borders', 'radius', 'tokens', 'overrides'],
        prose: 'Found <strong>14 redundant colors</strong> and <strong>23 spacing conflicts</strong> propagating through nested components.',
        actions: [
          { key: 'G', label: 'View graph' },
          { key: 'L', label: 'List conflicts' }
        ],
        placeholder: 'Ask about conflicts...',
        responses: { 
          'worst': 'Button.tsx is the main offender with 8 conflicting tokens.',
          'default': 'The coherence graph traces token inheritance through your component tree.' 
        }
      },
      '3': {
        color: 'green',
        title: 'Visual Drift',
        stat: '70%',
        statTarget: 70,
        statSup: 'reducible',
        suffix: '%',
        isDecimal: false,
        ticker: ['consistency', 'predictability', 'coherence', 'stability', 'uniformity', 'structure', 'alignment', 'tokens'],
        prose: 'Estimated reduction in visual drift. <strong>47 components</strong> auto-correct once tokens are unified.',
        actions: [
          { key: 'F', label: 'Apply now', primary: true },
          { key: 'S', label: 'Simulate' }
        ],
        placeholder: 'Ask about impact...',
        responses: { 
          'why 70': 'The 70% comes from cascade analysis â€” tracking how changes propagate.',
          'default': 'Impact is calculated by tracing token dependencies.' 
        }
      }
    };

    let fixActions = [];

    const predefinedFixActions = [
      { 
        title: 'Adding type annotations', 
        file: 'src/utils/formatters.ts', 
        ticker: ['typescript', 'inference', 'strict', 'generics', 'annotations', 'params', 'return', 'compile'],
        prose: 'Three utility functions lacked explicit return types. Adding annotations improves IDE support and catches potential type mismatches at compile time.',
        dialogue: [
          { agent: 1, text: 'Scanning <code>formatDate()</code>, <code>formatCurrency()</code>, and <code>formatNumber()</code>...' },
          { agent: 2, text: 'Inferring return types from 47 call sites across the codebase' },
          { agent: 3, text: 'All three return <code>string</code> consistently â€” no conflicts' },
          { agent: 1, text: 'Applied <code>: string</code> annotations to all three functions' },
        ]
      },
      { 
        title: 'Adding error boundaries', 
        file: 'src/components/App.tsx', 
        ticker: ['boundary', 'fallback', 'recovery', 'crashguard', 'graceful', 'catchall', 'suspend', 'wrap'],
        prose: 'The component tree had no crash protection. Wrapping with ErrorBoundary ensures graceful degradation instead of white-screen failures.',
        dialogue: [
          { agent: 1, text: 'Analyzing render patterns in <code>App.tsx</code>...' },
          { agent: 2, text: 'Found 3 components with async data dependencies that could throw' },
          { agent: 3, text: 'Creating <code>ErrorBoundary</code> wrapper with fallback UI' },
          { agent: 2, text: 'Wrapped <code>Dashboard</code>, <code>UserProfile</code>, and <code>DataTable</code>' },
        ]
      },
      { 
        title: 'Removing unused imports', 
        file: 'src/services/api.ts', 
        ticker: ['treeshake', 'unused', 'deadcode', 'bundle', 'optimize', 'purge', 'slim', 'remove'],
        prose: 'Dead imports add noise and slightly increase bundle size. Removing them keeps the codebase clean and helps tooling work faster.',
        dialogue: [
          { agent: 2, text: 'Tracing import graph for <code>api.ts</code>...' },
          { agent: 1, text: 'Found unused: <code>lodash</code>, <code>moment</code>, <code>uuid</code>, <code>chalk</code>' },
          { agent: 3, text: 'Confirmed no side effects â€” these are pure imports' },
          { agent: 2, text: 'Removed 4 imports, saving ~12KB from bundle' },
        ]
      },
      { 
        title: 'Consolidating color tokens', 
        file: 'src/styles/theme.ts', 
        ticker: ['tokens', 'palette', 'variables', 'brand', 'hex', 'unify', 'css', 'semantic'],
        prose: 'Fourteen instances of the same blue were hardcoded across files. Unifying to a single token makes future changes trivial.',
        dialogue: [
          { agent: 2, text: 'Cross-referencing <code>theme.ts</code> with component styles...' },
          { agent: 1, text: 'Found <code>#3b82f6</code> hardcoded in 14 places' },
          { agent: 3, text: 'Creating <code>--color-primary</code> token in theme.ts' },
          { agent: 2, text: 'Replaced all 14 instances â€” zero visual changes' },
        ]
      },
      { 
        title: 'Adding null checks', 
        file: 'src/hooks/useAuth.ts', 
        ticker: ['optional', 'chaining', 'guard', 'nullish', 'coalesce', 'runtime', 'undefined', 'safe'],
        prose: 'Two property accesses could fail if the auth state was null. Optional chaining prevents "Cannot read property of undefined" errors.',
        dialogue: [
          { agent: 1, text: 'Scanning <code>useAuth</code> for nullable access patterns...' },
          { agent: 3, text: 'Found <code>user.profile.email</code> and <code>session.token</code> unsafe' },
          { agent: 2, text: 'Applied <code>?.</code> operator: <code>user?.profile?.email</code>' },
          { agent: 1, text: 'Runtime safety improved â€” no more null crashes' },
        ]
      },
      { 
        title: 'Updating deprecated APIs', 
        file: 'src/services/auth.ts', 
        ticker: ['migration', 'supabase', 'nextauth', 'deprecation', 'legacy', 'upgrade', 'v2', 'breaking'],
        prose: 'The old subscription API will be removed in the next major version. Migrating now prevents breaking changes.',
        dialogue: [
          { agent: 2, text: 'Checking <code>auth.ts</code> for deprecated patterns...' },
          { agent: 1, text: 'Found legacy <code>onAuthStateChange()</code> callback' },
          { agent: 3, text: 'Migrating to <code>supabase.auth.onAuthStateChange()</code> v2 pattern' },
          { agent: 2, text: 'API updated, all 12 auth tests still passing' },
        ]
      },
      { 
        title: 'Fixing spacing inconsistencies', 
        file: 'src/components/Button.tsx', 
        ticker: ['baseline', 'grid', 'padding', 'margin', 'align', 'visual', 'rhythm', 'normalize'],
        prose: 'Button padding was 14px instead of the 16px grid baseline. Small inconsistencies compound into visual jankiness.',
        dialogue: [
          { agent: 1, text: 'Analyzing spacing in <code>Button.tsx</code>...' },
          { agent: 2, text: 'Found <code>padding: 14px</code> â€” 2px off grid' },
          { agent: 3, text: 'Normalizing to <code>padding: 16px</code> (2 grid units)' },
          { agent: 1, text: 'Visual consistency restored across all 23 button instances' },
        ]
      },
      { 
        title: 'Adding missing tests', 
        file: 'src/utils/validators.ts', 
        ticker: ['jest', 'coverage', 'assertions', 'unit', 'mock', 'expect', 'describe', 'edge'],
        prose: 'Six edge cases had no test coverage. Generating tests now catches regressions before they reach production.',
        dialogue: [
          { agent: 3, text: 'Analyzing coverage for <code>validators.ts</code>...' },
          { agent: 1, text: 'Uncovered: empty string, null input, unicode, max length, negative, zero' },
          { agent: 2, text: 'Generating <code>validators.test.ts</code> with 6 new cases' },
          { agent: 3, text: 'All tests passing â€” coverage increased from 78% to 94%' },
        ]
      },
      { 
        title: 'Optimizing bundle', 
        file: 'package.json', 
        ticker: ['webpack', 'vite', 'esbuild', 'minify', 'split', 'chunk', 'lazy', 'preload'],
        prose: 'Eight exported functions were never imported anywhere. Tree-shaking them reduces the final bundle by 12%.',
        dialogue: [
          { agent: 2, text: 'Analyzing bundle with <code>webpack-bundle-analyzer</code>...' },
          { agent: 1, text: 'Found 8 dead exports in <code>utils/index.ts</code>' },
          { agent: 3, text: 'Marking as <code></code> for tree-shaking' },
          { agent: 2, text: 'Bundle reduced from 847KB to 745KB (12% smaller)' },
        ]
      },
      { 
        title: 'Fixing accessibility', 
        file: 'src/components/Form.tsx', 
        ticker: ['wcag', 'aria', 'screenreader', 'focus', 'contrast', 'label', 'role', 'navigate'],
        prose: 'Five form inputs had no accessible labels. Screen readers couldn\'t identify what each field was for.',
        dialogue: [
          { agent: 1, text: 'Running <code>axe-core</code> audit on <code>Form.tsx</code>...' },
          { agent: 3, text: 'Found 5 inputs missing labels' },
          { agent: 2, text: 'Adding aria-label attributes' },
          { agent: 1, text: 'WCAG 2.1 AA compliance achieved' },
        ]
      },
      { 
        title: 'Updating dependencies', 
        file: 'package.json', 
        ticker: ['audit', 'patch', 'cve', 'advisory', 'semver', 'lockfile', 'deps', 'secure'],
        prose: 'Three packages had known vulnerabilities. Updating to patched versions closes these security holes.',
        dialogue: [
          { agent: 2, text: 'Running <code>npm audit</code>...' },
          { agent: 1, text: 'Found CVEs in <code>lodash</code>, <code>axios</code>, <code>ws</code>' },
          { agent: 3, text: 'Verifying semver compatibility with updates' },
          { agent: 2, text: 'Updated 3 packages â€” all tests passing' },
        ]
      },
      { 
        title: 'Extracting shared component', 
        file: 'src/components/Card.tsx', 
        ticker: ['abstract', 'compose', 'reuse', 'extract', 'base', 'props', 'shared', 'dry'],
        prose: 'Three card variants duplicated the same structure. Extracting a base component saves 47 lines and centralizes styling.',
        dialogue: [
          { agent: 1, text: 'Analyzing <code>ProductCard</code>, <code>UserCard</code>, <code>ProjectCard</code>...' },
          { agent: 2, text: 'Found 87% structural similarity across all three' },
          { agent: 3, text: 'Extracting <code>CardBase</code> with configurable slots' },
          { agent: 1, text: 'Refactored all three to use <code>CardBase</code> â€” 47 lines removed' },
        ]
      },
      { 
        title: 'Adding JSDoc comments', 
        file: 'src/services/api.ts', 
        ticker: ['jsdoc', 'intellisense', 'tooltip', 'readme', 'params', 'returns', 'example', 'comment'],
        prose: 'Eight public functions had no documentation. JSDoc comments enable better IDE tooltips and generated docs.',
        dialogue: [
          { agent: 3, text: 'Scanning exports in <code>api.ts</code>...' },
          { agent: 1, text: 'Found <code>fetchUser</code>, <code>updateUser</code>, <code>deleteUser</code>... (8 total)' },
          { agent: 2, text: 'Generating JSDoc with <code>@param</code> and <code>@returns</code> annotations' },
          { agent: 3, text: 'Documentation complete â€” IntelliSense now shows hints' },
        ]
      },
      { 
        title: 'Fixing memory leak', 
        file: 'src/hooks/useWebSocket.ts', 
        ticker: ['cleanup', 'unmount', 'dispose', 'listener', 'gc', 'retain', 'subscribe', 'abort'],
        prose: 'The WebSocket subscription wasn\'t cleaned up on unmount. This caused listeners to accumulate and memory to leak.',
        dialogue: [
          { agent: 2, text: 'Tracing <code>useEffect</code> in <code>useWebSocket</code>...' },
          { agent: 1, text: 'Found <code>socket.on()</code> without matching <code>socket.off()</code>' },
          { agent: 3, text: 'Adding cleanup: <code>return () => socket.off()</code>' },
          { agent: 2, text: 'Memory leak patched â€” verified with React DevTools Profiler' },
        ]
      },
    ];

    function getActivityContent() {
      if (!fixAllInProgress && Object.keys(activityTaskStates).length === 0) {
        return `
          <div class="activity-view">
            <div class="activity-header">
              <div class="activity-title-area">
                <div class="activity-title">Agent Activity</div>
                <div class="activity-subtitle">Real-time agent operations and fixes</div>
              </div>
            </div>
            <div class="activity-empty">
              <div class="activity-empty-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
              </div>
              <div class="activity-empty-text">No active operations</div>
              <div class="activity-empty-hint">Click "Fix All Issues" to start automated fixes</div>
            </div>
          </div>
        `;
      }

      const completedCount = Object.values(activityTaskStates).filter(s => s.status === 'complete').length;
      const totalCount = fixActions.length;
      const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

      return `
        <div class="activity-view">
          <div class="activity-header">
            <div class="activity-title-area">
              <div class="activity-title">Fixing All Issues</div>
              <div class="activity-subtitle">Automated code improvements in progress</div>
            </div>
            <div class="activity-stats">
              <div class="activity-stat">
                <div class="activity-stat-value" id="complete-count">${completedCount}</div>
                <div class="activity-stat-label">Complete</div>
              </div>
              <div class="activity-stat">
                <div class="activity-stat-value">${totalCount - completedCount}</div>
                <div class="activity-stat-label">Remaining</div>
              </div>
            </div>
          </div>

          <div class="activity-progress">
            <div class="activity-progress-header">
              <div class="activity-progress-title">
                <span>${fixAllInProgress ? 'Processing...' : 'Complete'}</span>
              </div>
              <div class="activity-progress-percent">${progressPercent}%</div>
            </div>
            <div class="activity-progress-bar">
              <div class="activity-progress-fill" style="width: ${progressPercent}%"></div>
            </div>
          </div>

          <div class="activity-stream" id="activity-stream">
            ${fixActions.map((action, i) => {
              const state = activityTaskStates[i] || { status: 'pending', progress: 0, expanded: false };
              const statusClass = state.status;

              const isExpanded = state.expanded === true;
              const tickerHtml = action.ticker ? 
                [...action.ticker, ...action.ticker].map(t => `<span>${t}</span>`).join('') : '';

              return `
                <div class="activity-task ${statusClass} ${isExpanded ? 'expanded' : ''}" 
                     data-task-index="${i}" 
                     style="--index: ${i}">
                  <div class="task-header">
                    <div class="task-status-icon">
                      ${state.status === 'complete' 
                        ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>'
                        : state.status === 'active'
                          ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>'
                          : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/></svg>'
                      }
                    </div>
                    <div class="task-info">
                      <div class="task-title">${action.title}</div>
                      <div class="task-file">${action.file}</div>
                    </div>
                    <button class="task-expand-btn">+</button>
                  </div>
                  <div class="task-progress">
                    <div class="task-progress-bar">
                      <div class="task-progress-fill" style="width: ${state.progress || 0}%"></div>
                    </div>
                  </div>
                  ${action.ticker ? `
                    <div class="task-ticker">
                      <div class="ticker-track">${tickerHtml}</div>
                    </div>
                  ` : ''}
                  <div class="task-dialogue">
                    ${action.prose ? `
                      <div class="task-prose">${action.prose}</div>
                    ` : ''}
                    <div class="task-dialogue-inner" id="dialogue-${i}">

                    </div>
                    <div class="task-input-area">
                      <span class="task-input-arrow">&#x2192;</span>
                      <input type="text" class="task-input-field" placeholder="Ask about this fix...">
                      <span class="task-input-hint"><kbd>&#x21B5;</kbd></span>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function setupTaskCardInteractions() {
      document.querySelectorAll('.activity-task').forEach(task => {
        const expandBtn = task.querySelector('.task-expand-btn');
        const index = parseInt(task.dataset.taskIndex);

        if (expandBtn) {
          expandBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleTaskExpansion(task, index);
          });
        }

        task.addEventListener('click', (e) => {

          if (e.target.closest('input') || e.target.closest('button')) return;
          toggleTaskExpansion(task, index);
        });
      });
    }

    function toggleTaskExpansion(taskEl, index) {

      if (!activityTaskStates[index]) {
        activityTaskStates[index] = { status: 'pending', progress: 0, expanded: false };
      }

      const state = activityTaskStates[index];
      const isCurrentlyExpanded = taskEl.classList.contains('expanded');

      state.expanded = !isCurrentlyExpanded;
      taskEl.classList.toggle('expanded', state.expanded);

      playSound(state.expanded ? 'tab' : 'cancel');
    }

    async function typeAgentMessage(dialogueEl, agent, text, speed = 45) {
      const msgEl = document.createElement('div');
      msgEl.className = `agent-msg agent-${agent}`;
      msgEl.innerHTML = `<span class="agent-dot"></span><span class="agent-msg-text"></span>`;
      dialogueEl.appendChild(msgEl);

      const textEl = msgEl.querySelector('.agent-msg-text');
      textEl.innerHTML = '<span class="typing-cursor"></span>';
      const cursor = textEl.querySelector('.typing-cursor');

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = text;
      const plainText = tempDiv.textContent || tempDiv.innerText;
      const words = plainText.split(' ');

      for (let i = 0; i < words.length; i++) {
        cursor.insertAdjacentText('beforebegin', (i > 0 ? ' ' : '') + words[i]);
        await new Promise(r => setTimeout(r, speed + Math.random() * 20));
      }

      cursor.remove();

      textEl.innerHTML = text;

      dialogueEl.scrollTop = dialogueEl.scrollHeight;
    }

    async function streamTaskDialogue(taskIndex) {
      const action = fixActions[taskIndex];
      const dialogueEl = document.getElementById(`dialogue-${taskIndex}`);
      if (!dialogueEl || !action.dialogue) return;

      dialogueEl.innerHTML = '';

      for (const msg of action.dialogue) {
        await typeAgentMessage(dialogueEl, msg.agent, msg.text);
        await new Promise(r => setTimeout(r, 300 + Math.random() * 200));
      }
    }

    function setupCardInteractions() {
      document.querySelectorAll('.insight-card').forEach(card => {
        card.addEventListener('click', (e) => {

          if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'KBD') return;

          const id = card.dataset.id;
          const isExpanding = !expandedCards.has(id);

          if (isExpanding) {
            expandedCards.add(id);
            card.classList.add('expanded');
            playSound('tab'); // 04 SFX Category Decide for expand
          } else {
            expandedCards.delete(id);
            card.classList.remove('expanded');
            playSound('cancel'); // 03 SFX Cancel for collapse
          }
        });

        card.querySelectorAll('.action-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (btn.classList.contains('primary')) {
              btn.classList.add('used');
              showStatus('Applying...', 0);
              setTimeout(() => updateStatusProgress(50), 200);
              setTimeout(() => updateStatusProgress(100), 400);
              setTimeout(() => showStatusSuccess('Done'), 600);
              setTimeout(() => hideStatus(), 2500);
            }
            playSound('confirm');
          });
        });

        const input = card.querySelector('.expanded-input input');
        if (input) {
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
              addCardResponse(card, input.value);
              input.value = '';
            }
          });
          input.addEventListener('click', (e) => e.stopPropagation());
        }
      });
    }

    function addCardResponse(card, query) {
      const conversationArea = card.querySelector('.card-conversation');
      if (!conversationArea) return;

      const responses = {
        'why': 'Based on static analysis of code patterns, dependencies, and test coverage metrics.',
        'how': 'You can fix this by running the suggested action, or I can guide you through manually.',
        'safe': 'Yes, this change is safe. It\'s a pure refactor with no functional impact.',
        'default': 'I can help with that. Would you like me to apply the suggested fix?'
      };

      let response = responses.default;
      for (const [key, val] of Object.entries(responses)) {
        if (query.toLowerCase().includes(key)) {
          response = val;
          break;
        }
      }

      const exchange = document.createElement('div');
      exchange.className = 'card-exchange';
      exchange.innerHTML = `
        <div class="card-query"><span class="arrow">â†’</span>${query}</div>
        <div class="card-response">${response}</div>
      `;
      conversationArea.appendChild(exchange);
      playSound('confirm');
    }

    let currentSortState = {
      features: { field: 'score', dir: 'desc' },
      'tech-debt': { field: 'severity', dir: 'asc' },
      tests: { field: 'coverage', dir: 'desc' }
    };

    function setupSortDropdowns() {
      document.querySelectorAll('.sort-dropdown-container').forEach(container => {
        const btn = container.querySelector('.sort-dropdown');
        const menu = container.querySelector('.sort-menu');
        const sortType = container.dataset.sortType;

        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = menu.classList.contains('open');

          document.querySelectorAll('.sort-menu.open').forEach(m => m.classList.remove('open'));
          document.querySelectorAll('.sort-dropdown.active').forEach(b => b.classList.remove('active'));

          if (!isOpen) {
            menu.classList.add('open');
            btn.classList.add('active');
            playSound('cursor');
          }
        });

        menu.querySelectorAll('.sort-menu-item').forEach(item => {
          item.addEventListener('click', (e) => {
            e.stopPropagation();
            const sortField = item.dataset.sort;
            const currentField = currentSortState[sortType].field;

            if (sortField === currentField) {
              currentSortState[sortType].dir = currentSortState[sortType].dir === 'desc' ? 'asc' : 'desc';
            } else {

              currentSortState[sortType].dir = (sortField === 'name') ? 'asc' : 
                (sortField === 'severity') ? 'asc' : 'desc';
            }
            currentSortState[sortType].field = sortField;

            menu.querySelectorAll('.sort-menu-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');

            const labelMap = {
              score: 'Score', name: 'Name', files: 'File Count',
              severity: 'Severity', issues: 'Issue Count',
              coverage: 'Coverage', tests: 'Test Count'
            };
            btn.querySelector('.sort-dropdown-text').textContent = labelMap[sortField] || sortField;
            btn.classList.toggle('asc', currentSortState[sortType].dir === 'asc');

            menu.classList.remove('open');
            btn.classList.remove('active');

            applySorting(sortType);
            playSound('decide');
          });
        });
      });

      document.addEventListener('click', () => {
        document.querySelectorAll('.sort-menu.open').forEach(m => m.classList.remove('open'));
        document.querySelectorAll('.sort-dropdown.active').forEach(b => b.classList.remove('active'));
      });
    }

    function applySorting(sortType) {
      const { field, dir } = currentSortState[sortType];
      let listId, data;

      if (sortType === 'features') {
        listId = 'features-list';
        data = [...featuresData];
      } else if (sortType === 'tech-debt') {
        listId = 'tech-debt-list';
        data = [...techDebtData];
      } else if (sortType === 'tests') {
        listId = 'tests-list';
        data = [...testsData];
      }

      data.sort((a, b) => {
        let valA, valB;

        switch(field) {
          case 'score':
          case 'coverage':
            valA = a.score;
            valB = b.score;
            break;
          case 'severity':
            valA = a.score;
            valB = b.score;
            break;
          case 'name':
            valA = a.name.toLowerCase();
            valB = b.name.toLowerCase();
            break;
          case 'files':
            valA = a.files ? a.files.length : 0;
            valB = b.files ? b.files.length : 0;
            break;
          case 'issues':
            valA = a.issues ? a.issues.length : 0;
            valB = b.issues ? b.issues.length : 0;
            break;
          case 'tests':
            valA = a.tests || 0;
            valB = b.tests || 0;
            break;
          default:
            valA = a.score;
            valB = b.score;
        }

        if (typeof valA === 'string') {
          return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
        return dir === 'asc' ? valA - valB : valB - valA;
      });

      const list = document.getElementById(listId);
      if (!list) return;

      list.style.opacity = '0';
      list.style.transform = 'translateY(8px)';

      setTimeout(() => {

        if (sortType === 'features') {
          list.innerHTML = data.map(f => renderFeatureCard(f)).join('');
        } else if (sortType === 'tech-debt') {
          list.innerHTML = data.map(f => renderTechDebtCard(f)).join('');
        } else if (sortType === 'tests') {
          list.innerHTML = data.map(t => renderTestCard(t)).join('');
        }

        setupCardInteractions();
        setupScrollIndicators();

        list.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        list.style.opacity = '1';
        list.style.transform = 'translateY(0)';
      }, 150);
    }

    function renderFeatureCard(f) {
      return `
        <div class="insight-card" data-id="${f.id}">
          <div class="insight-card-main">
            <div class="insight-score ${f.color}">
              <span class="insight-score-num">${f.score}</span><span class="insight-score-unit">/10</span>
            </div>
            <div class="insight-card-content">
              <div class="insight-card-title">${f.name}</div>
              <div class="insight-card-desc">${f.desc}</div>
              <div class="insight-card-meta">
                ${f.meta.map(m => `<span class="insight-meta-badge">${m}</span>`).join('')}
              </div>
            </div>
            <span class="insight-card-expand">+</span>
          </div>
          <div class="insight-expanded">
            <div class="scroll-indicator">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </div>
            <div class="expanded-section">
              <div class="expanded-section-label">Analysis</div>
              <p class="annotation-prose">${f.prose}</p>
            </div>
            <div class="expanded-section">
              <div class="expanded-section-label">Files</div>
              <div class="insight-file-list">
                ${f.files.map(file => `<div class="insight-file-item">â†’ ${file}</div>`).join('')}
              </div>
            </div>
            <div class="card-conversation"></div>
            <div class="expanded-input">
              <span class="arrow">â†’</span>
              <input type="text" placeholder="Ask about this feature...">
            </div>
            <div class="expanded-actions">
              ${f.actions.map(a => `
                <button class="action-btn ${a.primary ? 'primary' : 'secondary'}">
                  <kbd>${a.key}</kbd> ${a.label}
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderTechDebtCard(f) {
      return `
        <div class="insight-card" data-id="${f.id}">
          <div class="insight-card-main">
            <div class="insight-score ${f.color}">
              <span class="insight-score-num">${f.score}</span><span class="insight-score-unit">/10</span>
            </div>
            <div class="insight-card-content">
              <div class="insight-card-title" style="font-family: var(--font-mono); font-size: 13px;">${f.name}</div>
              <div class="insight-card-desc">${f.desc}</div>
              <div class="insight-card-meta">
                ${f.issues.map(i => `<span class="insight-meta-badge">${i}</span>`).join('')}
              </div>
            </div>
            <span class="insight-card-expand">+</span>
          </div>
          <div class="insight-expanded">
            <div class="scroll-indicator">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </div>
            <div class="expanded-section">
              <div class="expanded-section-label">Analysis</div>
              <p class="annotation-prose">${f.prose}</p>
            </div>
            <div class="card-conversation"></div>
            <div class="expanded-input">
              <span class="arrow">â†’</span>
              <input type="text" placeholder="Ask about this issue...">
            </div>
            <div class="expanded-actions">
              ${f.actions.map(a => `
                <button class="action-btn ${a.primary ? 'primary' : 'secondary'}">
                  <kbd>${a.key}</kbd> ${a.label}
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderTestCard(t) {
      return `
        <div class="insight-card" data-id="${t.name.replace('/', '')}">
          <div class="insight-card-main">
            <div class="insight-score ${t.color}">
              <span class="insight-score-num">${t.score}</span><span class="insight-score-unit">%</span>
            </div>
            <div class="insight-card-content">
              <div class="insight-card-title" style="font-family: var(--font-mono);">${t.name}</div>
              <div class="insight-card-desc">${t.tests} tests, ${t.coverage} line coverage</div>
              <div class="insight-card-meta">
                <span class="insight-meta-badge">${t.desc.split('.')[0]}</span>
              </div>
            </div>
            <span class="insight-card-expand">+</span>
          </div>
          <div class="insight-expanded">
            <div class="scroll-indicator">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </div>
            <div class="expanded-section">
              <div class="expanded-section-label">Details</div>
              <p class="annotation-prose">${t.desc}</p>
            </div>
            <div class="expanded-section">
              <div class="expanded-section-label">Test Files</div>
              <div class="insight-file-list">
                ${t.files.map(file => `<div class="insight-file-item">â†’ ${file}</div>`).join('')}
              </div>
            </div>
            <div class="card-conversation"></div>
            <div class="expanded-input">
              <span class="arrow">â†’</span>
              <input type="text" placeholder="Ask about coverage...">
            </div>
            <div class="expanded-actions">
              <button class="action-btn primary">
                <kbd>G</kbd> Generate tests
              </button>
              <button class="action-btn secondary">
                <kbd>R</kbd> Run tests
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function setupScrollIndicators() {
      document.querySelectorAll('.insight-card').forEach(card => {
        const expanded = card.querySelector('.insight-expanded');
        if (!expanded) return;

        const hasFiles = expanded.querySelector('.insight-file-list');
        const sectionCount = expanded.querySelectorAll('.expanded-section').length;
        const hasConversation = expanded.querySelector('.card-conversation');

        const hasMoreContent = hasFiles || sectionCount >= 2;

        if (hasMoreContent) {
          expanded.classList.add('has-more');
        } else {
          expanded.classList.remove('has-more');
        }
      });
    }

    function getEditorContent() {
      return `
        <div class="editor-tabs">
          <div class="editor-tab active">
            <span>App.tsx</span>
            <span class="close">Ã—</span>
          </div>
          <div class="editor-tab">
            <span>ChatPanel.tsx</span>
            <span class="close">Ã—</span>
          </div>
        </div>
        <div class="stats-row">
          <div class="stat-card neutral" id="stat-coverage" data-hotkey="1">
            <div class="stat-header">
              <span class="stat-hotkey">1</span>
              <span class="stat-label">Test Coverage</span>
            </div>
            <div class="stat-main">
              <div class="stat-value">8.4</div>
              <div class="stat-info">
                <div class="stat-sublabel">12 tests passing</div>
              </div>
            </div>
            <div class="stat-expanded">
              <div class="stat-summary">
                Your test coverage is <strong>strong at 84%</strong> line coverage. All behavior types are tested including <em>edge cases</em>.
              </div>
              <div class="stat-qa">
                <div class="stat-qa-item">
                  <div class="stat-qa-question"><span class="arrow">â†’</span> What needs attention?</div>
                  <div class="stat-qa-answer">Error handling paths in <code>useEffect</code> hooks could use additional coverage.</div>
                </div>
              </div>
              <div class="stat-conversation" id="stat-conversation-coverage"></div>
              <div class="stat-input">
                <span class="input-arrow">â†’</span>
                <input type="text" class="stat-input-field" data-card="coverage" placeholder="Ask about coverage...">
                <span class="input-hint"><kbd>â†µ</kbd></span>
              </div>
              <div class="stat-actions">
                <button class="stat-action-btn" onclick="handleStatAction('coverage', 'generate')"><kbd>F</kbd> Improve coverage</button>
                <button class="stat-action-btn" onclick="handleStatAction('coverage', 'open')"><kbd>â†µ</kbd> Open full view</button>
              </div>
            </div>
          </div>
          <div class="stat-card neutral" id="stat-quality" data-hotkey="2">
            <div class="stat-header">
              <span class="stat-hotkey">2</span>
              <span class="stat-label">Code Quality</span>
            </div>
            <div class="stat-main">
              <div class="stat-value">7.8</div>
              <div class="stat-info">
                <div class="stat-sublabel">3 suggestions</div>
              </div>
            </div>
            <div class="stat-expanded">
              <div class="stat-summary">
                This file has <strong>good code quality</strong> with some areas for improvement. <em>Maintainability</em> scores lowest at <code>7/10</code>.
              </div>
              <div class="stat-qa">
                <div class="stat-qa-item">
                  <div class="stat-qa-question"><span class="arrow">â†’</span> What are the main issues?</div>
                  <div class="stat-qa-answer">Type annotations could be more explicit. Consider adding <code>ErrorBoundary</code> for robustness.</div>
                </div>
              </div>
              <div class="stat-conversation" id="stat-conversation-quality"></div>
              <div class="stat-input">
                <span class="input-arrow">â†’</span>
                <input type="text" class="stat-input-field" data-card="quality" placeholder="Ask about quality...">
                <span class="input-hint"><kbd>â†µ</kbd></span>
              </div>
              <div class="stat-actions">
                <button class="stat-action-btn" onclick="handleStatAction('quality', 'fix')"><kbd>F</kbd> Fix top issue</button>
                <button class="stat-action-btn" onclick="handleStatAction('quality', 'open')"><kbd>â†µ</kbd> Open full view</button>
              </div>
            </div>
          </div>
        </div>
        <div class="editor-code" id="editor-code">
          <div class="code-line"><span class="line-num">1</span><span class="code-keyword">import</span> React <span class="code-keyword">from</span> <span class="code-string">'react'</span>;</div>
          <div class="code-line"><span class="line-num">2</span><span class="code-keyword">import</span> { useSelector } <span class="code-keyword">from</span> <span class="code-string">'react-redux'</span>;</div>
          <div class="code-line"><span class="line-num">3</span><span class="code-keyword">import</span> { ChatPanel } <span class="code-keyword">from</span> <span class="code-string">'./ChatPanel'</span>;</div>
          <div class="code-line"><span class="line-num">4</span></div>
          <div class="code-line"><span class="line-num">5</span><span class="code-comment">// Main application component</span></div>
          <div class="code-line"><span class="line-num">6</span><span class="code-keyword">export default function</span> <span class="code-function">App</span>() {</div>
          <div class="code-line"><span class="line-num">7</span>  <span class="code-keyword">const</span> user = <span class="code-function">useSelector</span>(s => s.user);</div>
          <div class="code-line"><span class="line-num">8</span>  <span class="code-keyword">const</span> project = <span class="code-function">useSelector</span>(s => s.project);</div>
          <div class="code-line"><span class="line-num">9</span></div>
          <div class="code-line"><span class="line-num">10</span>  <span class="code-keyword">if</span> (!user) <span class="code-keyword">return</span> <span class="code-string">&lt;AuthPage /&gt;</span>;</div>
          <div class="code-line"><span class="line-num">11</span></div>
          <div class="code-line"><span class="line-num">12</span>  <span class="code-keyword">return</span> (</div>
          <div class="code-line"><span class="line-num">13</span>    &lt;<span class="code-type">ThemeProvider</span> theme=<span class="code-string">"dark"</span>&gt;</div>
          <div class="code-line"><span class="line-num">14</span>      &lt;<span class="code-type">Layout</span>&gt;</div>
          <div class="code-line"><span class="line-num">15</span>        &lt;<span class="code-type">ChatPanel</span> projectId={project.id} /&gt;</div>
          <div class="code-line"><span class="line-num">16</span>      &lt;/<span class="code-type">Layout</span>&gt;</div>
          <div class="code-line"><span class="line-num">17</span>    &lt;/<span class="code-type">ThemeProvider</span>&gt;</div>
          <div class="code-line"><span class="line-num">18</span>  );</div>
          <div class="code-line"><span class="line-num">19</span>}</div>
        </div>
      `;
    }

    function getFeaturesContent() {
      return `
        <div class="insight-container">
          <div class="insight-header">
            <h2 class="insight-title">Features</h2>
            <p class="insight-summary"><span class="highlight">Four</span> distinct features detected. Click any card to explore, ask questions, or apply fixes.</p>
          </div>

          <div class="insight-toolbar">
            <div class="search-box">
              <span class="search-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.35-4.35"/></svg></span>
              <input type="text" placeholder="Search features...">
            </div>
            <div class="filter-pills">
              <button class="filter-pill active">All</button>
              <button class="filter-pill">High score</button>
              <button class="filter-pill">Needs work</button>
            </div>
            <div class="spacer"></div>
            <div class="sort-dropdown-container" data-sort-type="features">
              <button class="sort-dropdown" data-current-sort="score" data-sort-dir="desc">
                <div class="sort-icon"><span></span><span></span><span></span></div>
                <span class="sort-dropdown-text">Score</span>
              </button>
              <div class="sort-menu">
                <div class="sort-menu-item active" data-sort="score">
                  Score
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div class="sort-menu-item" data-sort="name">
                  Name
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div class="sort-menu-item" data-sort="files">
                  File Count
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
              </div>
            </div>
          </div>

          <div class="insight-stats">
            <div class="insight-stat">
              <div class="insight-stat-value-row">
                <div class="insight-stat-value amber">7.5</div>
                <span class="insight-stat-desc">clarity, completeness, cohesion</span>
              </div>
              <div class="insight-stat-label">Avg Score</div>
            </div>
            <div class="insight-stat">
              <div class="insight-stat-value-row">
                <div class="insight-stat-value green">4</div>
                <span class="insight-stat-desc">detected in codebase</span>
              </div>
              <div class="insight-stat-label">Features</div>
            </div>
            <div class="insight-stat">
              <div class="insight-stat-value-row">
                <div class="insight-stat-value">12</div>
                <span class="insight-stat-desc">contributing to features</span>
              </div>
              <div class="insight-stat-label">Files</div>
            </div>
          </div>

          <div class="insight-section-label">Detected Features</div>
          <div class="insight-list" id="features-list">
            ${featuresData.map(f => `
              <div class="insight-card" data-id="${f.id}">
                <div class="insight-card-main">
                  <div class="insight-score ${f.color}">
                    <span class="insight-score-num">${f.score}</span><span class="insight-score-unit">/10</span>
                  </div>
                  <div class="insight-card-content">
                    <div class="insight-card-title">${f.name}</div>
                    <div class="insight-card-desc">${f.desc}</div>
                    <div class="insight-card-meta">
                      ${f.meta.map(m => `<span class="insight-meta-badge">${m}</span>`).join('')}
                    </div>
                  </div>
                  <span class="insight-card-expand">+</span>
                </div>
                <div class="insight-expanded">
                  <div class="scroll-indicator">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="6 9 12 15 18 9"/>
                    </svg>
                  </div>
                  <div class="expanded-section">
                    <div class="expanded-section-label">Analysis</div>
                    <p class="annotation-prose">${f.prose}</p>
                  </div>
                  <div class="expanded-section">
                    <div class="expanded-section-label">Files</div>
                    <div class="insight-file-list">
                      ${f.files.map(file => `<div class="insight-file-item">â†’ ${file}</div>`).join('')}
                    </div>
                  </div>
                  <div class="card-conversation"></div>
                  <div class="expanded-input">
                    <span class="arrow">â†’</span>
                    <input type="text" placeholder="Ask about this feature...">
                  </div>
                  <div class="expanded-actions">
                    ${f.actions.map(a => `
                      <button class="action-btn ${a.primary ? 'primary' : 'secondary'}">
                        <kbd>${a.key}</kbd> ${a.label}
                      </button>
                    `).join('')}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function getTechDebtContent() {
      return `
        <div class="insight-container">
          <div class="insight-header">
            <h2 class="insight-title">Tech Debt Overview</h2>
            <p class="insight-summary"><span class="highlight">Two</span> critical issues detected across <span class="highlight">four</span> files. Fix issues with a single click.</p>
          </div>

          <div class="insight-toolbar">
            <div class="search-box">
              <span class="search-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.35-4.35"/></svg></span>
              <input type="text" placeholder="Search files...">
            </div>
            <div class="filter-pills">
              <button class="filter-pill active">All</button>
              <button class="filter-pill">Critical</button>
              <button class="filter-pill">Moderate</button>
            </div>
            <div class="spacer"></div>
            <div class="sort-dropdown-container" data-sort-type="tech-debt">
              <button class="sort-dropdown" data-current-sort="severity" data-sort-dir="asc">
                <div class="sort-icon"><span></span><span></span><span></span></div>
                <span class="sort-dropdown-text">Severity</span>
              </button>
              <div class="sort-menu">
                <div class="sort-menu-item active" data-sort="severity">
                  Severity
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div class="sort-menu-item" data-sort="name">
                  File Name
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div class="sort-menu-item" data-sort="issues">
                  Issue Count
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
              </div>
            </div>
          </div>

          <div class="insight-stats">
            <div class="insight-stat">
              <div class="insight-stat-value-row">
                <div class="insight-stat-value amber">5.0</div>
                <span class="insight-stat-desc">maintainability, extensibility</span>
              </div>
              <div class="insight-stat-label">Avg Score</div>
            </div>
            <div class="insight-stat">
              <div class="insight-stat-value-row">
                <div class="insight-stat-value red">2</div>
                <span class="insight-stat-desc">issues to fix</span>
              </div>
              <div class="insight-stat-label">Critical</div>
            </div>
            <div class="insight-stat">
              <div class="insight-stat-value-row">
                <div class="insight-stat-value">4</div>
                <span class="insight-stat-desc">analyzed for debt</span>
              </div>
              <div class="insight-stat-label">Files</div>
            </div>
          </div>

          <div class="insight-section-label">Files by Tech Debt</div>
          <div class="insight-list" id="tech-debt-list">
            ${techDebtData.map(f => `
              <div class="insight-card" data-id="${f.id}">
                <div class="insight-card-main">
                  <div class="insight-score ${f.color}">
                    <span class="insight-score-num">${f.score}</span><span class="insight-score-unit">/10</span>
                  </div>
                  <div class="insight-card-content">
                    <div class="insight-card-title" style="font-family: var(--font-mono); font-size: 13px;">${f.name}</div>
                    <div class="insight-card-desc">${f.desc}</div>
                    <div class="insight-card-meta">
                      ${f.issues.map(i => `<span class="insight-meta-badge">${i}</span>`).join('')}
                    </div>
                  </div>
                  <span class="insight-card-expand">+</span>
                </div>
                <div class="insight-expanded">
                  <div class="scroll-indicator">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="6 9 12 15 18 9"/>
                    </svg>
                  </div>
                  <div class="expanded-section">
                    <div class="expanded-section-label">Analysis</div>
                    <p class="annotation-prose">${f.prose}</p>
                  </div>
                  <div class="card-conversation"></div>
                  <div class="expanded-input">
                    <span class="arrow">â†’</span>
                    <input type="text" placeholder="Ask about this issue...">
                  </div>
                  <div class="expanded-actions">
                    ${f.actions.map(a => `
                      <button class="action-btn ${a.primary ? 'primary' : 'secondary'}">
                        <kbd>${a.key}</kbd> ${a.label}
                      </button>
                    `).join('')}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function getTestsContent() {
      return `
        <div class="insight-container">
          <div class="insight-header">
            <h2 class="insight-title">Test Coverage</h2>
            <p class="insight-summary"><span class="highlight">Seventy-one percent</span> overall coverage across <span class="highlight">four</span> test suites. Expand to see test files and add missing tests.</p>
          </div>

          <div class="insight-toolbar">
            <div class="search-box">
              <span class="search-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.35-4.35"/></svg></span>
              <input type="text" placeholder="Search...">
            </div>
            <div class="filter-pills">
              <button class="filter-pill active">All</button>
              <button class="filter-pill">Low coverage</button>
            </div>
            <div class="spacer"></div>
            <div class="sort-dropdown-container" data-sort-type="tests">
              <button class="sort-dropdown" data-current-sort="coverage" data-sort-dir="desc">
                <div class="sort-icon"><span></span><span></span><span></span></div>
                <span class="sort-dropdown-text">Coverage</span>
              </button>
              <div class="sort-menu">
                <div class="sort-menu-item active" data-sort="coverage">
                  Coverage
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div class="sort-menu-item" data-sort="name">
                  Name
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div class="sort-menu-item" data-sort="tests">
                  Test Count
                  <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
              </div>
            </div>
          </div>

          <div class="insight-stats">
            <div class="insight-stat">
              <div class="insight-stat-value-row">
                <div class="insight-stat-value green">71%</div>
                <span class="insight-stat-desc">lines executed by tests</span>
              </div>
              <div class="insight-stat-label">Overall</div>
            </div>
            <div class="insight-stat">
              <div class="insight-stat-value-row">
                <div class="insight-stat-value">93</div>
                <span class="insight-stat-desc">passing</span>
              </div>
              <div class="insight-stat-label">Tests</div>
            </div>
            <div class="insight-stat">
              <div class="insight-stat-value-row">
                <div class="insight-stat-value green">4</div>
                <span class="insight-stat-desc">test files</span>
              </div>
              <div class="insight-stat-label">Suites</div>
            </div>
          </div>

          <div class="insight-section-label">Coverage by Directory</div>
          <div class="insight-list" id="tests-list">
            ${testsData.map(t => `
              <div class="insight-card" data-id="${t.name.replace('/', '')}">
                <div class="insight-card-main">
                  <div class="insight-score ${t.color}">
                    <span class="insight-score-num">${t.score}</span><span class="insight-score-unit">%</span>
                  </div>
                  <div class="insight-card-content">
                    <div class="insight-card-title" style="font-family: var(--font-mono);">${t.name}</div>
                    <div class="insight-card-desc">${t.tests} tests, ${t.coverage} line coverage</div>
                    <div class="insight-card-meta">
                      <span class="insight-meta-badge">${t.desc.split('.')[0]}</span>
                    </div>
                  </div>
                  <span class="insight-card-expand">+</span>
                </div>
                <div class="insight-expanded">
                  <div class="scroll-indicator">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="6 9 12 15 18 9"/>
                    </svg>
                  </div>
                  <div class="expanded-section">
                    <div class="expanded-section-label">Details</div>
                    <p class="annotation-prose">${t.desc}</p>
                  </div>
                  <div class="expanded-section">
                    <div class="expanded-section-label">Test Files</div>
                    <div class="insight-file-list">
                      ${t.files.map(file => `<div class="insight-file-item">â†’ ${file}</div>`).join('')}
                    </div>
                  </div>
                  <div class="card-conversation"></div>
                  <div class="expanded-input">
                    <span class="arrow">â†’</span>
                    <input type="text" placeholder="Ask about coverage...">
                  </div>
                  <div class="expanded-actions">
                    <button class="action-btn primary">
                      <kbd>G</kbd> Generate tests
                    </button>
                    <button class="action-btn secondary">
                      <kbd>R</kbd> Run tests
                    </button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function clearChat() {
      document.getElementById('chat-messages').innerHTML = '';
    }

    function typeInChat(text, speed = 50) {
      return new Promise(resolve => {
        const input = document.getElementById('chat-input');
        let i = 0;
        input.value = '';

        function typeChar() {
          if (i < text.length) {
            input.value += text[i];
            i++;
            setTimeout(typeChar, speed);
          } else {
            resolve();
          }
        }
        typeChar();
      });
    }

    function addQuery(text) {
      clearChat();
      const container = document.getElementById('chat-messages');
      const exchange = document.createElement('div');
      exchange.className = 'exchange';
      exchange.innerHTML = `
        <div class="query">
          <span class="query-arrow">â†’</span>
          <span class="query-text">${text}</span>
        </div>
        <div class="thinking">
          <div class="thinking-bar">
            <div class="thinking-bar-fill"></div>
          </div>
          <span class="thinking-text">Thinking...</span>
        </div>
      `;
      container.appendChild(exchange);
      container.scrollTop = container.scrollHeight;
      document.getElementById('chat-input').value = '';
      return exchange;
    }

    function showResponse(exchange, headline, detail) {
      return new Promise(resolve => {
        exchange.querySelector('.thinking').innerHTML = `
          <div class="response">
            <div class="response-headline">${headline}</div>
            <div class="response-detail">${detail}</div>
          </div>
        `;
        playSound('confirm');
        setTimeout(resolve, 500);
      });
    }

    function addAnnotationCard(filePath, color, headerText, prose, actions) {
      const container = document.getElementById('chat-messages');
      const card = document.createElement('div');
      card.className = `annotation-card ${color}`;
      card.id = 'pending-edit';

      const tickerItems = ['refactor', 'improve', 'fix', 'update'];
      const tickerHTML = tickerItems.map(t => `<span>${t}</span>`).join('') + 
                         tickerItems.map(t => `<span>${t}</span>`).join('');

      card.innerHTML = `
        <div class="annotation-left">
          <div class="annotation-header">
            <span class="header-key">${headerText.charAt(0)}</span>
            ${headerText}
          </div>
          <div class="stat-number">1<sup>file</sup></div>
          <div class="stat-ticker">
            <div class="ticker-inner">${tickerHTML}</div>
          </div>
        </div>
        <div class="annotation-right">
          <div class="annotation-path">${filePath}</div>
          <div class="annotation-prose">${prose}</div>
          <div class="annotation-actions">
            ${actions.map(a => `
              <button class="action-btn ${a.primary ? 'primary' : 'secondary'}">
                <kbd>${a.key}</kbd> ${a.label}
              </button>
            `).join('')}
          </div>
          <div class="annotation-input">
            <span class="input-arrow">â†’</span>
            <input type="text" class="card-input-field" placeholder="Ask about this change...">
            <span class="input-hint"><kbd>â†µ</kbd></span>
          </div>
        </div>
      `;
      container.appendChild(card);
      container.scrollTop = container.scrollHeight;
      playSound('cursor');
      return card;
    }

    function applyEdit(card) {
      return new Promise(resolve => {
        card.classList.add('applied');
        card.querySelector('.annotation-actions').innerHTML = `
          <div class="applied-indicator"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg> Applied</div>
        `;
        playSound('confirm');
        setTimeout(resolve, 500);
      });
    }

    async function runDemo() {
      if (demoRunning) return;
      demoRunning = true;

      const playBtn = document.getElementById('play-demo-btn');
      playBtn.textContent = 'Pause';
      playBtn.classList.add('active');

      showScreen('editor');

      switchTab('editor');
      clearChat();
      hideNarration();
      hideStatus();

      const wait = (ms) => new Promise(r => { 
        const t = setTimeout(r, ms); 
        demoTimeouts.push(t);
      });

      try {

        await wait(500);
        await showNarration('<em>Lattice</em> â€” AI-powered codebase intelligence', 3500);
        await wait(1000);

        await showNarration('Ask questions about your codebase in <em>natural language</em>', 3000);
        await moveCursorToElement('#chat-input', 0, 0);
        await clickCursor();
        await wait(300);
        await typeInChat('How does authentication work in this app?', 40);
        await wait(500);

        const exchange = addQuery('How does authentication work in this app?');
        await wait(2000);
        await showResponse(exchange, 
          'Authentication uses <em>OAuth 2.0</em> with JWT tokens',
          'Users sign in via Google or GitHub. The session is managed in Redux and persisted to local storage.'
        );
        await wait(1500);

        await showNarration('Discover <em>what your code does</em> â€” click to explore', 3000);
        await moveCursorToElement('#tab-features', -20, 0, 600);
        await wait(200);

        await moveCursorToElement('#tab-features', 20, 0, 400);
        await clickCursor();
        switchTab('features');
        await wait(1500);

        await showNarration('Cards expand to reveal <em>details and actions</em>', 2500);
        await moveCursorToElement('.insight-card[data-id="auth"]', 0, 0);
        await clickCursor();
        document.querySelector('.insight-card[data-id="auth"]').classList.add('expanded');
        expandedCards.add('auth');
        await wait(2000);

        await showNarration('Fix issues with <em>one click</em>', 3000);
        await moveCursorToElement('#tab-tech-debt', 0, 0);
        await clickCursor();
        switchTab('tech-debt');
        await wait(1500);

        await moveCursorToElement('.insight-card[data-id="formatters"]', 0, 0);
        await clickCursor();
        document.querySelector('.insight-card[data-id="formatters"]').classList.add('expanded');
        await wait(1500);

        await moveCursorToElement('.insight-card[data-id="formatters"] .action-btn.primary', 0, 0);
        await clickCursor();
        const fixBtn = document.querySelector('.insight-card[data-id="formatters"] .action-btn.primary');
        fixBtn.classList.add('used');
        showStatus('Adding types...', 0);
        await wait(300);
        updateStatusProgress(50);
        await wait(500);
        updateStatusProgress(100);
        await wait(300);
        showStatusSuccess('Types added');
        await wait(1500);

        hideStatus();
        await moveCursorToElement('#tab-editor', 0, 0);
        await clickCursor();
        switchTab('editor');
        await wait(500);

        await moveCursorToElement('#chat-input', 0, 0);
        await clickCursor();
        await wait(300);
        await typeInChat('Refactor auth to use next-auth', 40);
        await wait(500);

        const exchange2 = addQuery('Refactor auth to use next-auth');
        await wait(1500);
        await showResponse(exchange2,
          "I'll migrate to <em>next-auth</em>",
          'This will update the OAuth flow and improve security.'
        );
        await wait(500);

        const editCard = addAnnotationCard(
          'src/services/auth.ts',
          'green',
          'Edit',
          'Replacing deprecated OAuth 1.0 patterns with <strong>next-auth</strong>. Zero breaking changes.',
          [{ key: 'Y', label: 'Apply', primary: true }, { key: 'N', label: 'Reject', primary: false }]
        );
        await wait(1500);

        await moveCursorToElement('#pending-edit .action-btn.primary', 0, 0);
        await clickCursor();
        showStatus('Applying...', 0);
        await wait(300);
        updateStatusProgress(50);
        await wait(500);
        updateStatusProgress(100);
        await wait(300);

        await applyEdit(editCard);
        showStatusSuccess('Migration complete');

        await wait(2000);

        hideStatus();
        await showNarration('Track <em>test coverage</em> and generate missing tests', 3000);
        await moveCursorToElement('#tab-tests', 0, 0);
        await clickCursor();
        switchTab('tests');
        await wait(2500);

        await showNarration('Lattice â€” <em>Understand</em>, <em>improve</em>, and <em>ship</em> faster', 4000);
        await moveCursor(-50, -50, 500);

      } catch (e) {
        console.log('Demo interrupted');
      }

      demoRunning = false;
      playBtn.textContent = 'â–¶ Play Demo';
      playBtn.classList.remove('active');
    }

    function stopDemo() {
      demoTimeouts.forEach(t => clearTimeout(t));
      demoTimeouts = [];
      demoRunning = false;
      document.getElementById('play-demo-btn').textContent = 'Play Demo';
      document.getElementById('play-demo-btn').classList.remove('active');
    }

    function restartDemo() {
      stopDemo();
      showScreen('editor');
      switchTab('editor');
      clearChat();
      hideNarration();
      hideStatus();
      moveCursor(-50, -50, 100);
    }

    document.getElementById('play-demo-btn').addEventListener('click', () => {
      if (demoRunning) {
        stopDemo();
      } else {
        runDemo();
      }
    });

    document.getElementById('restart-btn').addEventListener('click', restartDemo);
    document.getElementById('sound-toggle').addEventListener('click', toggleSound);

    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        if (!demoRunning) {
          switchTab(tab.dataset.tab);
        }
      });
    });

    function setupStatCardInteractions() {
      document.querySelectorAll('.stat-card').forEach(card => {
        card.addEventListener('click', (e) => {

          if (e.target.closest('.stat-action-btn') || e.target.closest('.stat-input')) return;

          const isExpanded = card.classList.contains('expanded');

          if (!isExpanded) {
            card.classList.add('expanded');
            playSound('tab');
          } else {
            card.classList.remove('expanded');
            playSound('cancel');
          }
        });
      });

      document.querySelectorAll('.stat-action-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          playSound('confirm');

        btn.style.opacity = '0.5';
        btn.style.pointerEvents = 'none';
        btn.innerHTML = '<span style="color: var(--green);">Applied</span>';

        showStatus('Applying...', 0);
        setTimeout(() => updateStatusProgress(50), 200);
        setTimeout(() => updateStatusProgress(100), 500);
        setTimeout(() => showStatusSuccess('Done'), 700);
        setTimeout(() => hideStatus(), 2000);
      });
    });
    }

    const fixAllBtn = document.getElementById('fix-all-btn');
    if (fixAllBtn) {
      fixAllBtn.addEventListener('click', async () => {
        if (fixAllInProgress) return;

        playSound('confirm');
        fixAllInProgress = true;

        fixActions = [...predefinedFixActions];

        activityTaskStates = {};
        fixActions.forEach((_, i) => {
          activityTaskStates[i] = { status: 'pending', progress: 0, expanded: false };
        });

        switchTab('activity');

        fixAllBtn.classList.add('working');
        const fixText = fixAllBtn.querySelector('.fix-text');
        const fixKbd = fixAllBtn.querySelector('#fix-kbd');

        if (fixKbd) fixKbd.style.display = 'none';
        if (fixText) fixText.innerHTML = '<span class="fix-progress-text">0%</span>';

        const activityTab = document.getElementById('tab-activity');
        if (activityTab) activityTab.classList.add('has-activity');

        setupTaskCardInteractions();

        await new Promise(r => setTimeout(r, 1500));

        const TASK_DURATION = 5500; // 5.5 seconds per task
        const PROGRESS_INTERVAL = 50; // Update progress every 50ms

        for (let i = 0; i < fixActions.length; i++) {
          const overallProgress = ((i) / fixActions.length) * 100;
          fixAllBtn.style.setProperty('--progress', `${overallProgress}%`);
          if (fixText) fixText.innerHTML = `<span class="fix-progress-text">${Math.round(overallProgress)}%</span>`;

          activityTaskStates[i].status = 'active';
          activityTaskStates[i].expanded = true;

          const taskEl = document.querySelector(`.activity-task[data-task-index="${i}"]`);
          if (taskEl) {
            taskEl.classList.remove('pending');
            taskEl.classList.add('active', 'expanded');
            playSound('cursor');
          }

          const progressDuration = TASK_DURATION * 0.65;
          const progressSteps = progressDuration / PROGRESS_INTERVAL;
          let progressStep = 0;

          const progressPromise = new Promise(resolve => {
            const progressInterval = setInterval(() => {
              progressStep++;
              const taskProgress = Math.min((progressStep / progressSteps) * 100, 100);
              activityTaskStates[i].progress = taskProgress;

              const progressFill = taskEl?.querySelector('.task-progress-fill');
              if (progressFill) {
                progressFill.style.width = `${taskProgress}%`;
              }

              if (progressStep >= progressSteps) {
                clearInterval(progressInterval);
                resolve();
              }
            }, PROGRESS_INTERVAL);
          });

          await new Promise(r => setTimeout(r, 500));
          const dialoguePromise = streamTaskDialogue(i);

          await Promise.all([progressPromise, dialoguePromise]);

          await new Promise(r => setTimeout(r, 300));

          activityTaskStates[i].status = 'complete';
          activityTaskStates[i].progress = 100;

          if (taskEl) {
            taskEl.classList.remove('active');
            taskEl.classList.add('complete');

            const iconEl = taskEl.querySelector('.task-status-icon');
            if (iconEl) {
              iconEl.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
            }

            activityTaskStates[i].expanded = false;
            setTimeout(() => {
              if (activityTaskStates[i].status === 'complete' && !activityTaskStates[i].expanded) {
                taskEl.classList.remove('expanded');
              }
            }, 600);
          }

          const completedCount = Object.values(activityTaskStates).filter(s => s.status === 'complete').length;
          const remainingCount = fixActions.length - completedCount;

          const completeStatEl = document.getElementById('complete-count');
          const remainingStatEl = document.querySelector('.activity-stat:nth-child(2) .activity-stat-value');
          const headerProgressFill = document.querySelector('.activity-progress-fill');
          const headerProgressPercent = document.querySelector('.activity-progress-percent');

          if (completeStatEl) completeStatEl.textContent = completedCount;
          if (remainingStatEl) remainingStatEl.textContent = remainingCount;

          const headerProgress = Math.round((completedCount / fixActions.length) * 100);
          if (headerProgressFill) headerProgressFill.style.width = `${headerProgress}%`;
          if (headerProgressPercent) headerProgressPercent.textContent = `${headerProgress}%`;

          playSound('tab');

          const nextTaskEl = document.querySelector(`.activity-task[data-task-index="${i + 1}"]`);
          if (nextTaskEl) {
            nextTaskEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }

        fixAllInProgress = false;
        fixAllBtn.classList.remove('working');
        fixAllBtn.classList.add('complete');

        if (fixText) fixText.textContent = 'All Fixed';
        fixAllBtn.style.setProperty('--progress', '100%');

        const workingDot = document.querySelector('.activity-progress-title .working-dot');
        const processingText = document.querySelector('.activity-progress-title span:last-child');
        if (workingDot) workingDot.style.display = 'none';
        if (processingText) processingText.textContent = 'Complete';

        const issuesValue = document.getElementById('issues-value');
        const healthValue = document.getElementById('health-value');
        if (issuesValue) issuesValue.textContent = '0';
        if (healthValue) healthValue.textContent = '94%';

        setTimeout(() => {
          if (activityTab) activityTab.classList.remove('has-activity');
        }, 3000);

        playSound('confirm');
      });
    }

    initStreamTicker();

    createParticles();

    renderFileTree();

    switchTab('editor');

    const analysisPlayBtn = document.getElementById('analysis-play-btn');
    if (analysisPlayBtn) {
      analysisPlayBtn.addEventListener('click', runAnalysis);
    }

    const reportBtnEditor = document.getElementById('report-btn-editor');
    if (reportBtnEditor) {
      reportBtnEditor.addEventListener('click', () => {
        showScreen('editor');
        playSound('decide');
        switchTab('editor');
      });
    }

    const reportBtnFeatures = document.getElementById('report-btn-features');
    if (reportBtnFeatures) {
      reportBtnFeatures.addEventListener('click', () => {
        showScreen('editor');
        playSound('decide');
        switchTab('features');
      });
    }

    const reportBtnTechDebt = document.getElementById('report-btn-tech-debt');
    if (reportBtnTechDebt) {
      reportBtnTechDebt.addEventListener('click', () => {
        showScreen('editor');
        playSound('decide');
        switchTab('tech-debt');
      });
    }

    const reportBtnTests = document.getElementById('report-btn-tests');
    if (reportBtnTests) {
      reportBtnTests.addEventListener('click', () => {
        showScreen('editor');
        playSound('decide');
        switchTab('tests');
      });
    }

    document.querySelectorAll('.inline-badge').forEach(badge => {

      badge.addEventListener('click', (e) => {
        e.stopPropagation();
        const key = badge.dataset.key;
        if (activeDashboardAnnotation === key) {
          closeDashboardAnnotation(key);
        } else {
          openDashboardAnnotation(key);
        }
      });
    });

    document.addEventListener('keydown', (e) => {
      if (currentScreen === 'analysis') {
        if (e.key === 'Enter' && !analysisRunning) {
          runAnalysis();
        } else if (e.key === ' ' && analysisRunning) {
          e.preventDefault();
          skipAnalysis();
        }
      } else if (currentScreen === 'dashboard') {

        if (e.target.closest('.annotation-input-field')) {
          return;
        }

        if (e.key === '1' || e.key === '2' || e.key === '3') {
          e.preventDefault();
          toggleDashboardAnnotation(e.key);
        } else if (e.key === 'Escape') {

          if (activeDashboardAnnotation) {
            closeDashboardAnnotation(activeDashboardAnnotation);
          } else {
            showScreen('analysis');
            playSound('cancel');
          }
        } else if (e.key === 'e' || e.key === 'E') {
          showScreen('editor');
          playSound('decide');
          switchTab('editor');
        } else if (e.key === 'f' || e.key === 'F') {
          showScreen('editor');
          playSound('decide');
          switchTab('features');
        } else if (e.key === 't' || e.key === 'T') {
          showScreen('editor');
          playSound('decide');
          switchTab('tech-debt');
        } else if (e.key === 's' || e.key === 'S') {
          showScreen('editor');
          playSound('decide');
          switchTab('tests');
        }
      } else if (currentScreen === 'editor') {

        if (e.target.closest('input, textarea')) {
          return;
        }

        if (e.key === 'Escape') {

          const expandedCard = document.querySelector('.stat-card.expanded');
          if (expandedCard) {
            expandedCard.classList.remove('expanded');
            playSound('cancel');
            return;
          }
          showScreen('dashboard');
          playSound('cancel');
        } else if (e.key === '1' || e.key === '2') {

          e.preventDefault();
        } else if (e.key === 'Enter') {

          const expandedCard = document.querySelector('.stat-card.expanded');
          if (expandedCard) {
            e.preventDefault();
            const cardId = expandedCard.id;
            if (cardId === 'stat-coverage') {
              switchTab('tests');
            } else if (cardId === 'stat-quality') {
              switchTab('tech-debt');
            }
            expandedCard.classList.remove('expanded');
            playSound('decide');
          }
        } else if (e.key === 'f' || e.key === 'F') {

          const expandedCard = document.querySelector('.stat-card.expanded');
          if (expandedCard) {
            e.preventDefault();
            const primaryBtn = expandedCard.querySelector('.stat-action-btn.primary');
            if (primaryBtn) {
              primaryBtn.click();
            }
            return;
          }

          const fixAllBtn = document.getElementById('fix-all-btn');
          if (fixAllBtn && !fixAllInProgress) {
            fixAllBtn.click();
          }
        }
      }
    });

    function createDashboardAnnotation(key) {
      const data = dashboardCardData[key];
      const tickerItems = [...data.ticker, ...data.ticker].map(t => `<span>${t}</span>`).join('');
      const actionsHtml = data.actions.map(a => 
        `<div class="annotation-action ${a.primary ? 'primary' : ''}" data-action="${a.key}">
          <span class="key">${a.key}</span> ${a.label}
        </div>`
      ).join('');

      const div = document.createElement('div');
      div.className = `dashboard-annotation ${data.color}`;
      div.dataset.key = key;
      div.innerHTML = `
        <div class="annotation-left">
          <div class="annotation-header"><span class="header-key">${key}</span>${data.title}</div>
          <div class="annotation-stat"><span class="stat-value">0</span><sup>${data.statSup}</sup></div>
          <div class="annotation-ticker"><div class="annotation-ticker-inner">${tickerItems}</div></div>
        </div>
        <div class="annotation-right">
          <div class="card-conversation"></div>
          <div class="annotation-prose">${data.prose}</div>
          <div class="annotation-actions">${actionsHtml}</div>
          <div class="annotation-input">
            <span class="input-arrow">â†’</span>
            <input type="text" class="annotation-input-field" placeholder="${data.placeholder}">
            <span class="input-hint"><kbd>â†µ</kbd></span>
          </div>
        </div>
      `;

      const statEl = div.querySelector('.stat-value');
      setTimeout(() => {
        animateDashboardNumber(statEl, data.statTarget, 1000, data.isDecimal, data.suffix || '');
      }, 150);

      const inputField = div.querySelector('.annotation-input-field');
      if (inputField) {
        inputField.addEventListener('keydown', (e) => {

          if (e.key === '1' || e.key === '2' || e.key === '3') {
            e.preventDefault();
            if (e.key !== key) {

              closeDashboardAnnotation(key, () => {
                openDashboardAnnotation(e.key);
              });
            }
            return;
          }

          if (e.key === 'Escape') {
            e.preventDefault();
            closeDashboardAnnotation(key);
            return;
          }

          if (e.key === 'Backspace' && inputField.value === '') {
            e.preventDefault();
            closeDashboardAnnotation(key);
            return;
          }

          if (e.key === 'Enter' && inputField.value.trim()) {
            e.preventDefault();
            handleDashboardCardQuery(key, inputField.value.trim(), div);
            inputField.value = '';
            playSound('cursor');
          }
        });
      }

      div.querySelectorAll('.annotation-action').forEach(action => {
        action.addEventListener('click', () => {
          playSound('decide');
          closeDashboardAnnotation(key, () => {
            showScreen('editor');
            switchTab('tech-debt');
          });
        });
      });

      return div;
    }

    function animateDashboardNumber(element, target, duration = 1000, isDecimal = false, suffix = '') {
      const startTime = performance.now();
      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = target * eased;
        element.textContent = isDecimal ? current.toFixed(2) + suffix : Math.round(current) + suffix;
        if (progress < 1) requestAnimationFrame(update);
      }
      requestAnimationFrame(update);
    }

    function handleDashboardCardQuery(key, query, element) {
      const data = dashboardCardData[key];
      const convArea = element.querySelector('.card-conversation');
      let response = data.responses.default;
      for (const [trigger, resp] of Object.entries(data.responses)) {
        if (trigger !== 'default' && query.toLowerCase().includes(trigger)) { 
          response = resp; 
          break; 
        }
      }
      const exchange = document.createElement('div');
      exchange.className = 'card-exchange';
      exchange.innerHTML = `<div class="card-query"><span class="arrow">â†’</span>${query}</div><div class="card-response">${response}</div>`;
      convArea.appendChild(exchange);
    }

    function openDashboardAnnotation(key) {
      playSound('category');
      const badge = document.querySelector(`.inline-badge[data-key="${key}"]`);
      if (!badge) return;

      if (activeDashboardAnnotation) {
        closeDashboardAnnotation(activeDashboardAnnotation, () => { 
          if (activeDashboardAnnotation !== key) insertDashboardAnnotation(key, badge); 
        });
        return;
      }
      insertDashboardAnnotation(key, badge);
    }

    function insertDashboardAnnotation(key, badge) {
      const annotation = createDashboardAnnotation(key);
      badge.insertAdjacentElement('afterend', annotation);
      badge.classList.add('active');
      activeDashboardAnnotation = key;
      activeDashboardElement = annotation;
      const input = annotation.querySelector('.annotation-input-field');
      if (input) setTimeout(() => input.focus(), 100);
    }

    function closeDashboardAnnotation(key, callback) {
      const badge = document.querySelector(`.inline-badge[data-key="${key}"]`);
      if (activeDashboardElement) {
        activeDashboardElement.classList.add('closing');
        setTimeout(() => {
          if (activeDashboardElement?.parentNode) activeDashboardElement.parentNode.removeChild(activeDashboardElement);
          activeDashboardElement = null;
          activeDashboardAnnotation = null;
          if (callback) callback();
        }, 200);
      }
      if (badge) badge.classList.remove('active');
      playSound('cancel');
    }

    function toggleDashboardAnnotation(key) {
      if (activeDashboardAnnotation === key) {
        closeDashboardAnnotation(key);
      } else {
        openDashboardAnnotation(key);
      }
    }

    function toggleStatCard(cardId) {
      const card = document.getElementById(cardId);
      if (!card) return;

      card.classList.toggle('expanded');
      playSound(card.classList.contains('expanded') ? 'category' : 'cursor');
    }

    function handleStatAction(cardType, action) {
      const card = document.getElementById(cardType === 'coverage' ? 'stat-coverage' : 'stat-quality');

      if (action === 'open') {

        if (cardType === 'coverage') {
          switchTab('tests');
        } else {
          switchTab('tech-debt');
        }
        if (card) card.classList.remove('expanded');
        playSound('decide');
      } else if (action === 'generate' || action === 'fix') {

        const chatInput = document.querySelector('.chat-input');
        if (chatInput) {
          if (cardType === 'coverage') {
            chatInput.value = 'Improve test coverage for ChatPanel.tsx:\n- Add edge case tests for error handling\n- Test loading states and error boundaries';
          } else {
            chatInput.value = 'Fix code quality issues in ChatPanel.tsx:\n- Add explicit type annotations\n- Implement error boundaries';
          }
          chatInput.focus();
        }
        if (card) card.classList.remove('expanded');
        playSound('confirm');
      }
    }

    let statCardHoldTimer = null;
    let statCardHoldDelayTimer = null;
    let statCardHoldingKey = null;

    const statCardFixData = {
      '1': {
        title: 'Improving test coverage',
        file: 'src/components/ChatPanel.tsx',
        ticker: ['coverage', 'tests', 'hooks', 'edge', 'cases', 'assertions', 'mocks', 'async'],
        prose: 'Adding comprehensive tests for edge cases and error handling paths in useEffect hooks.',
        dialogue: [
          { agent: 1, text: 'Analyzing test gaps in <code>ChatPanel.tsx</code>...' },
          { agent: 2, text: 'Found 3 useEffect hooks without coverage' },
          { agent: 3, text: 'Generating tests for error boundaries and loading states' },
          { agent: 1, text: 'Applied new test file: <code>ChatPanel.test.tsx</code>' },
        ]
      },
      '2': {
        title: 'Fixing code quality issues',
        file: 'src/components/ChatPanel.tsx',
        ticker: ['types', 'annotations', 'boundaries', 'patterns', 'lint', 'refactor', 'clean', 'strict'],
        prose: 'Adding explicit type annotations and implementing error boundaries for improved robustness.',
        dialogue: [
          { agent: 1, text: 'Scanning for type annotation opportunities...' },
          { agent: 2, text: 'Found 5 implicit <code>any</code> types to annotate' },
          { agent: 3, text: 'Wrapping async components with ErrorBoundary' },
          { agent: 1, text: 'Applied type fixes and error boundaries' },
        ]
      }
    };

    const statCardResponses = {
      'coverage': {
        'why': 'The 84% threshold ensures critical paths are tested while allowing flexibility for UI code.',
        'how': 'Add tests for useEffect cleanup, error states, and loading transitions.',
        'what': 'Missing coverage in error handling paths and async state transitions.',
        'default': 'Test coverage measures how much of your code is exercised by automated tests.'
      },
      'quality': {
        'why': 'Type annotations catch bugs at compile time and improve IDE support.',
        'how': 'Run the fix to add explicit types and wrap components in ErrorBoundary.',
        'what': 'Three implicit any types and missing error boundaries detected.',
        'default': 'Code quality measures adherence to best practices and maintainability.'
      }
    };

    function startStatCardHold(hotkey) {
      const cardId = hotkey === '1' ? 'stat-coverage' : 'stat-quality';
      const card = document.getElementById(cardId);
      if (!card || card.classList.contains('confirmed')) return;

      statCardHoldingKey = hotkey;

      statCardHoldDelayTimer = setTimeout(() => {
        card.classList.add('filling');

        statCardHoldTimer = setTimeout(() => {
          card.classList.remove('filling');
          card.classList.add('confirmed');

          const hotkeyBadge = card.querySelector('.stat-hotkey');
          if (hotkeyBadge) hotkeyBadge.textContent = 'âœ“';

          card.classList.remove('expanded');

          statCardHoldingKey = null;
          playSound('confirm');

          addStatCardFixToActivity(hotkey);
        }, 1500);
      }, 250);
    }

    function cancelStatCardHold() {
      if (statCardHoldDelayTimer) {
        clearTimeout(statCardHoldDelayTimer);
        statCardHoldDelayTimer = null;
      }
      if (statCardHoldTimer) {
        clearTimeout(statCardHoldTimer);
        statCardHoldTimer = null;
      }

      if (statCardHoldingKey) {
        const cardId = statCardHoldingKey === '1' ? 'stat-coverage' : 'stat-quality';
        const card = document.getElementById(cardId);
        if (card) {
          card.classList.remove('filling');
        }
        statCardHoldingKey = null;
      }
    }

    function addStatCardFixToActivity(hotkey) {
      const data = statCardFixData[hotkey];
      if (!data) return;

      const newAction = {
        title: data.title,
        file: data.file,
        ticker: data.ticker,
        prose: data.prose,
        dialogue: data.dialogue
      };

      fixActions.unshift(newAction);

      const newStates = { 0: { status: 'active', progress: 0, expanded: true } };
      Object.keys(activityTaskStates).forEach(key => {
        newStates[parseInt(key) + 1] = activityTaskStates[key];
      });
      activityTaskStates = newStates;

      switchTab('activity');

      setTimeout(() => {
        processActivityTask(0);
      }, 500);
    }

    async function processActivityTask(taskIndex) {
      const taskEl = document.querySelector(`.activity-task[data-task-index="${taskIndex}"]`);
      if (!taskEl) return;

      activityTaskStates[taskIndex] = { status: 'active', progress: 0, expanded: true };
      taskEl.classList.remove('pending');
      taskEl.classList.add('active', 'expanded');

      await streamTaskDialogue(taskIndex);

      for (let p = 0; p <= 100; p += 5) {
        activityTaskStates[taskIndex].progress = p;
        const fill = taskEl.querySelector('.task-progress-fill');
        if (fill) fill.style.width = `${p}%`;
        await new Promise(r => setTimeout(r, 80));
      }

      activityTaskStates[taskIndex].status = 'complete';
      taskEl.classList.remove('active');
      taskEl.classList.add('complete');

      const iconEl = taskEl.querySelector('.task-status-icon');
      if (iconEl) {
        iconEl.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
      }

      activityTaskStates[taskIndex].expanded = false;
      setTimeout(() => {
        if (activityTaskStates[taskIndex].status === 'complete' && !activityTaskStates[taskIndex].expanded) {
          taskEl.classList.remove('expanded');
        }
      }, 600);

      playSound('confirm');
    }

    function handleStatCardQuery(cardType, query) {
      const convEl = document.getElementById(`stat-conversation-${cardType}`);
      if (!convEl) return;

      const responses = statCardResponses[cardType] || {};
      let response = responses.default || 'I can help you understand this metric.';

      const lowerQuery = query.toLowerCase();
      for (const [trigger, resp] of Object.entries(responses)) {
        if (trigger !== 'default' && lowerQuery.includes(trigger)) {
          response = resp;
          break;
        }
      }

      const exchange = document.createElement('div');
      exchange.className = 'stat-exchange';
      exchange.innerHTML = `
        <div class="stat-query"><span class="arrow">â†’</span> ${query}</div>
        <div class="stat-response">${response}</div>
      `;
      convEl.appendChild(exchange);
      playSound('cursor');
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.addEventListener('keydown', (e) => {
        if (e.target.classList.contains('stat-input-field')) {
          if (e.key === 'Enter' && e.target.value.trim()) {
            e.preventDefault();
            const cardType = e.target.dataset.card;
            handleStatCardQuery(cardType, e.target.value.trim());
            e.target.value = '';
          }
        }
      });
    });

    document.addEventListener('keydown', (e) => {
      if (currentScreen !== 'editor') return;
      if (e.target.closest('input, textarea')) return;
      if (e.repeat) return; // Ignore key repeat

      if (e.key === '1' || e.key === '2') {
        startStatCardHold(e.key);
      }
    });

    document.addEventListener('keyup', (e) => {
      if (currentScreen !== 'editor') return;

      if (e.key === '1' || e.key === '2') {
        const cardId = e.key === '1' ? 'stat-coverage' : 'stat-quality';
        const card = document.getElementById(cardId);

        if (statCardHoldingKey === e.key) {
          cancelStatCardHold();

          if (card && !card.classList.contains('confirmed')) {
            toggleStatCard(cardId);
          }
        }
      }
    });

    const aiResponses = [
      {
        headline: "Pattern Analysis Complete",
        detail: `I've traced the data flow through your component hierarchy. The <span class="highlight">useCallback</span> dependency array in <span class="code-ref">Dashboard.tsx:47</span> is missing <span class="highlight">filterState</span>, causing stale closures on rapid filter changes. This cascades into 3 downstream effects.`,
        actions: [
          { key: 'F', label: 'Fix dependency', primary: true },
          { key: 'S', label: 'Show cascade' }
        ]
      },
      {
        headline: "Semantic Drift Detected", 
        detail: `Cross-referencing your <span class="highlight">Button</span> variants against the design tokens reveals <span class="highlight">7 color overrides</span> that bypass your theme system. Most appear in <span class="code-ref">legacy/</span> components. Consolidating would reduce your CSS surface by ~340 lines.`,
        actions: [
          { key: 'C', label: 'Consolidate', primary: true },
          { key: 'M', label: 'Map overrides' }
        ]
      },
      {
        headline: "Architectural Insight",
        detail: `Your <span class="highlight">API layer</span> follows a consistent pattern except for <span class="code-ref">services/auth.ts</span> which mixes concerns. Extracting the token refresh logic into a dedicated interceptor would align with your existing patterns and improve testability.`,
        actions: [
          { key: 'R', label: 'Refactor', primary: true },
          { key: 'D', label: 'Show diff' }
        ]
      },
      {
        headline: "Performance Opportunity",
        detail: `Profiling your render cycles shows <span class="highlight">UserCard</span> re-renders 12x per navigation. The culprit: an inline object in <span class="code-ref">Layout.tsx:89</span> creates a new reference each render. Memoizing drops this to 2x.`,
        actions: [
          { key: 'O', label: 'Optimize', primary: true },
          { key: 'P', label: 'Profile view' }
        ]
      }
    ];

    let responseIndex = 0;

    function addUserMessage(text) {
      const container = document.getElementById('chat-messages');

      const emptyState = container.querySelector('.chat-empty');
      if (emptyState) emptyState.remove();

      const userMsg = document.createElement('div');
      userMsg.className = 'chat-user-message';
      userMsg.innerHTML = `
        <span class="user-arrow">â†’</span>
        <span class="user-text">${text}</span>
      `;
      container.appendChild(userMsg);
      container.scrollTop = container.scrollHeight;

      const thinking = document.createElement('div');
      thinking.className = 'chat-thinking';
      thinking.innerHTML = `
        <div class="thinking-dots">
          <span></span><span></span><span></span>
        </div>
      `;
      container.appendChild(thinking);
      container.scrollTop = container.scrollHeight;

      setTimeout(() => {
        thinking.remove();
        addAIResponse();
      }, 1200 + Math.random() * 800);
    }

    function addAIResponse() {
      const container = document.getElementById('chat-messages');
      const response = aiResponses[responseIndex % aiResponses.length];
      responseIndex++;

      const aiMsg = document.createElement('div');
      aiMsg.className = 'chat-ai-response';
      aiMsg.innerHTML = `
        <div class="response-headline">${response.headline}</div>
        <div class="response-detail">${response.detail}</div>
        <div class="response-actions">
          ${response.actions.map(a => `
            <button class="response-action-btn ${a.primary ? 'primary' : ''}">
              <kbd>${a.key}</kbd> ${a.label}
            </button>
          `).join('')}
        </div>
      `;
      container.appendChild(aiMsg);
      container.scrollTop = container.scrollHeight;
      playSound('confirm');
    }

    document.getElementById('chat-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const input = e.target;
        const text = input.value.trim();
        if (text) {
          addUserMessage(text);
          input.value = '';
        }
      }
    });
  </script>
</body>
</html>
